{
  "gitSyncId": "6904ab7642599522ad71b295_333f8967-5080-4df3-b031-48fe0e8ae2b0",
  "id": "Home_rotas_bi_motoboy",
  "pluginId": "oracle-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "encodeParamsToggle": true,
      "formData": {
        "body": {
          "data": "WITH ped AS (\n  SELECT \n    c.numped,\n    d.codcli,\n    CASE \n      WHEN c.posicao = 'E' THEN 'ENTREGA'\n      WHEN c.posicao = 'R' THEN 'RETIRADA'\n      WHEN c.posicao = 'T' THEN 'TRANSPORTADORA'\n      ELSE '' \n    END AS posicao,\n    f.codrotainservivel || ' - ' || f.descricao AS rota,\n    c.datafimpacote,\n    CASE \n      WHEN f.descricao LIKE '%FIXA%' THEN \n        CASE \n          WHEN c.datafimpacote <= TRUNC(c.datafimpacote) + INTERVAL '9' HOUR + INTERVAL '15' MINUTE \n            THEN CAST(TRUNC(c.datafimpacote) + INTERVAL '9' HOUR + INTERVAL '30' MINUTE AS TIMESTAMP)\n          WHEN c.datafimpacote <= TRUNC(c.datafimpacote) + INTERVAL '13' HOUR + INTERVAL '15' MINUTE \n            THEN CAST(TRUNC(c.datafimpacote) + INTERVAL '13' HOUR + INTERVAL '30' MINUTE AS TIMESTAMP)\n          ELSE CAST(TRUNC(c.datafimpacote + 1) + INTERVAL '9' HOUR + INTERVAL '30' MINUTE AS TIMESTAMP)\n        END\n      ELSE CAST(c.datafimpacote AS TIMESTAMP)\n    END AS ts_partida\n  FROM tab_pedconf c\n  JOIN pcpedc d ON d.numped = c.numped\n  JOIN pcclient e ON e.codcli = d.codcli\n  JOIN pcrotainservivel f ON f.codrotainservivel = e.codrotainservivel\n  WHERE c.posicao = 'E'\n    AND c.datafimpacote BETWEEN \n      TO_DATE({{ moment(DatePicker_Data_Inicio.selectedDate).format(\"DD-MM-YYYY\") }}, 'DD-MM-YYYY')\n      AND \n      TO_DATE({{ moment(DatePicker_Data_Fim.selectedDate).format(\"DD-MM-YYYY\") }}, 'DD-MM-YYYY') + 1 - INTERVAL '1' SECOND\n)\n, base AS (\n  SELECT \n    t.codfilial,\n    p.numped,\n    p.codcli,\n    p.posicao,\n    p.datafimpacote,\n    t.saidaid,\n    t.codmotorista,\n    t.nomemotsaida,\n    p.rota,\n    t.datasaida,\n    t.dataentrega,\n    t.dataretorno,\n    COUNT(*) OVER(PARTITION BY t.saidaid) AS total_pedidos,\n    COUNT(t.dataentrega) OVER(PARTITION BY t.saidaid) AS total_entregues,\n    COUNT(*) OVER(PARTITION BY t.saidaid) - COUNT(t.dataentrega) OVER(PARTITION BY t.saidaid) AS total_pendentes,\n    MAX(t.dataentrega) OVER(PARTITION BY t.saidaid) AS max_dataentrega,\n    p.ts_partida,\n    CASE \n      WHEN t.datasaida <= p.ts_partida THEN 0 \n      ELSE TRUNC((NVL(t.datasaida, SYSDATE) - CAST(p.ts_partida AS DATE)) * 1440) \n    END AS minutos,\n    NUMTODSINTERVAL(TRUNC((t.dataentrega - CAST(p.ts_partida AS DATE)) * 1440), 'MINUTE') AS tempo\n  FROM ped p\n  LEFT JOIN tab_saidamoto t ON t.numped = p.numped\n  WHERE t.saidaid >= 45000\n)\nSELECT \n  posicao,\n  (SELECT TAB_GRUPOFILIAL.SIGLA \n     FROM TAB_GRUPOFILIAL \n    WHERE TAB_GRUPOFILIAL.CODFILIAL = base.codfilial) AS FILIAL,\n  base.codfilial,\n  numped,\n  codcli,\n  rota,\n  CASE \n    WHEN ROTA LIKE '%FIXA%' THEN 'FIXA'\n    WHEN ROTA LIKE '%TRANSPORTADORA%' THEN 'TRANSPORTADORA'\n    ELSE 'IMEDIATA'\n  END AS TIPO,\n\n  /* --- datas originais (para ordenar/filtrar no Appsmith se desejar) --- */\n  datafimpacote,\n  datasaida,\n  dataentrega,\n  dataretorno,\n\n  /* --- datas formatadas com hora para exibição --- */\n  TO_CHAR(ts_partida,   'DD/MM/YYYY HH24:MI:SS') AS PREVISAO_SAIDA,\n  TO_CHAR(datafimpacote,'DD/MM/YYYY HH24:MI:SS') AS DATAFIMPACOTE_STR,\n  TO_CHAR(datasaida,    'DD/MM/YYYY HH24:MI:SS') AS DATASAIDA_STR,\n  TO_CHAR(dataentrega,  'DD/MM/YYYY HH24:MI:SS') AS DATAENTREGA_STR,\n  TO_CHAR(dataretorno,  'DD/MM/YYYY HH24:MI:SS') AS DATARETORNO_STR,\n\n  minutos AS MINUTOS_ATRASO,\n  saidaid,\n  total_entregues || '/' || total_pedidos AS QT_PEDIDOS,\n  codmotorista,\n  nomemotsaida\nFROM base\nWHERE 1 = 1\n--AND ROTA LIKE '%FIXA%'\n--AND dataretorno IS NULL\n--AND saidaid IN (46404, 46436, 46433)\n\n"
        },
        "preparedStatement": {
          "data": true
        }
      },
      "paginationType": "NONE",
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "WINDONBLUE",
      "isAutoGenerated": false,
      "name": "WINDONBLUE",
      "pluginId": "oracle-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "formData.body.data"
      }
    ],
    "name": "rotas_bi_motoboy",
    "pageId": "Home",
    "runBehaviour": "ON_PAGE_LOAD",
    "userSetOnLoad": true
  }
}