{
  "animateLoading": true,
  "borderOpacity": 100,
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": 1,
  "bottomRow": 133,
  "boxShadow": "{{appsmith.theme.boxShadow.appBoxShadow}}",
  "dynamicBindingPathList": [
    {
      "key": "borderRadius"
    },
    {
      "key": "boxShadow"
    },
    {
      "key": "srcDoc"
    }
  ],
  "dynamicTriggerPathList": [],
  "flexVerticalAlignment": "start",
  "isLoading": false,
  "isVisible": true,
  "key": "ga1dblt3lx",
  "leftColumn": 0,
  "mobileBottomRow": 32,
  "mobileLeftColumn": 0,
  "mobileRightColumn": 24,
  "mobileTopRow": 0,
  "needsErrorInfo": false,
  "parentColumnSpace": 27.359375,
  "parentId": "btyjemjlw4",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "responsiveBehavior": "fill",
  "rightColumn": 64,
  "source": "https://www.example.com",
  "srcDoc": "<style>\n    * {\n        margin: 0;\n        padding: 0;\n        box-sizing: border-box;\n    }\n\n    body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;\n        background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n        min-height: 100vh;\n        padding: 20px;\n    }\n\n    .retorno-container {\n        max-width: 1600px;\n        margin: 0 auto;\n    }\n\n    /* ========== HEADER ========== */\n    .retorno-header {\n        background: white;\n        padding: 32px;\n        border-radius: 16px;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.12);\n        margin-bottom: 24px;\n        position: relative;\n        overflow: hidden;\n    }\n\n    .retorno-header::before {\n        content: '';\n        position: absolute;\n        top: -50%;\n        right: -10%;\n        width: 500px;\n        height: 500px;\n        background: radial-gradient(circle, rgba(16,185,129,0.1) 0%, transparent 70%);\n        pointer-events: none;\n    }\n\n    .live-badge {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));\n        border: 2px solid #ef4444;\n        padding: 10px 16px;\n        border-radius: 25px;\n        font-weight: 700;\n        font-size: 12px;\n        color: #ef4444;\n        z-index: 2;\n        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);\n        backdrop-filter: blur(10px);\n    }\n\n    .live-dot {\n        width: 10px;\n        height: 10px;\n        background: #ef4444;\n        border-radius: 50%;\n        animation: pulse-live 2s infinite;\n    }\n\n    @keyframes pulse-live {\n        0%, 100% {\n            opacity: 1;\n            transform: scale(1);\n            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);\n        }\n        50% {\n            opacity: 0.8;\n            transform: scale(1.1);\n            box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);\n        }\n    }\n\n    .retorno-title {\n        font-size: 36px;\n        font-weight: 900;\n        background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n        margin-bottom: 8px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        position: relative;\n        z-index: 1;\n    }\n\n    .retorno-subtitle {\n        font-size: 16px;\n        color: #6b7280;\n        font-weight: 600;\n        position: relative;\n        z-index: 1;\n    }\n\n    /* ========== FILTRO ========== */\n    .filtro-section {\n        background: white;\n        padding: 24px 32px;\n        border-radius: 16px;\n        box-shadow: 0 4px 16px rgba(0,0,0,0.08);\n        margin-bottom: 24px;\n        display: flex;\n        align-items: center;\n        gap: 20px;\n        flex-wrap: wrap;\n    }\n\n    .filtro-label {\n        font-size: 14px;\n        font-weight: 700;\n        color: #374151;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n    }\n\n    .filtro-select {\n        flex: 1;\n        min-width: 300px;\n        padding: 14px 20px;\n        border: 3px solid #10b981;\n        border-radius: 12px;\n        font-size: 16px;\n        font-weight: 600;\n        color: #111827;\n        background: white;\n        cursor: pointer;\n        transition: all 0.2s;\n    }\n\n    .filtro-select:focus {\n        outline: none;\n        border-color: #059669;\n        box-shadow: 0 0 0 4px rgba(16,185,129,0.1);\n    }\n\n    .btn-limpar {\n        padding: 14px 24px;\n        background: #ef4444;\n        color: white;\n        border: none;\n        border-radius: 12px;\n        font-size: 14px;\n        font-weight: 700;\n        cursor: pointer;\n        transition: all 0.2s;\n    }\n\n    .btn-limpar:hover {\n        background: #dc2626;\n        transform: translateY(-2px);\n    }\n\n    /* ========== RESUMO CARDS ========== */\n    .resumo-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n        gap: 16px;\n        margin-bottom: 24px;\n    }\n\n    .resumo-card {\n        background: white;\n        padding: 24px;\n        border-radius: 16px;\n        box-shadow: 0 4px 16px rgba(0,0,0,0.08);\n        text-align: center;\n        transition: all 0.2s;\n        position: relative;\n        overflow: hidden;\n    }\n\n    .resumo-card::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 4px;\n        background: linear-gradient(90deg, #10b981, #059669);\n    }\n\n    .resumo-card:hover {\n        transform: translateY(-4px);\n        box-shadow: 0 8px 24px rgba(0,0,0,0.12);\n    }\n\n    .resumo-icon {\n        font-size: 48px;\n        margin-bottom: 12px;\n    }\n\n    .resumo-value {\n        font-size: 42px;\n        font-weight: 900;\n        color: #10b981;\n        line-height: 1;\n        margin-bottom: 8px;\n    }\n\n    .resumo-label {\n        font-size: 13px;\n        font-weight: 700;\n        color: #6b7280;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n    }\n\n    /* ========== LISTA ========== */\n    .lista-section {\n        background: white;\n        padding: 24px 32px;\n        border-radius: 16px;\n        box-shadow: 0 4px 16px rgba(0,0,0,0.08);\n        margin-bottom: 24px;\n    }\n\n    .lista-title {\n        font-size: 20px;\n        font-weight: 800;\n        color: #374151;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding-bottom: 16px;\n        border-bottom: 3px solid #f3f4f6;\n    }\n\n    .lista-header {\n        display: grid;\n        grid-template-columns: 50px 110px 170px 120px 75px 110px 110px 95px 95px 130px 1fr;\n        gap: 8px;\n        padding: 14px 16px;\n        background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n        color: white;\n        border-radius: 8px;\n        font-size: 11px;\n        font-weight: 700;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        margin-bottom: 8px;\n    }\n\n    .lista-body {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n    }\n\n    .lista-item {\n        display: grid;\n        grid-template-columns: 50px 110px 170px 120px 75px 110px 110px 95px 95px 130px 1fr;\n        gap: 8px;\n        padding: 16px;\n        background: white;\n        border: 2px solid #f3f4f6;\n        border-radius: 8px;\n        align-items: center;\n        font-size: 12px;\n        transition: all 0.2s;\n        animation: slideIn 0.3s ease;\n    }\n\n    @keyframes slideIn {\n        from {\n            opacity: 0;\n            transform: translateY(-10px);\n        }\n        to {\n            opacity: 1;\n            transform: translateY(0);\n        }\n    }\n\n    .lista-item:hover {\n        border-color: #10b981;\n        box-shadow: 0 4px 12px rgba(16,185,129,0.15);\n        transform: translateX(5px);\n    }\n\n    .item-numero {\n        font-weight: 900;\n        color: #10b981;\n        text-align: center;\n        font-size: 18px;\n    }\n\n    .item-motoboy {\n        font-weight: 700;\n        color: #111827;\n        font-size: 14px;\n    }\n\n    .item-codigo {\n        font-weight: 600;\n        color: #6b7280;\n        font-family: 'Courier New', monospace;\n    }\n\n    .item-filial {\n        display: inline-block;\n        padding: 6px 12px;\n        background: #dbeafe;\n        color: #1e40af;\n        border-radius: 6px;\n        font-weight: 700;\n        font-size: 12px;\n    }\n\n    .item-hora {\n        font-weight: 700;\n        color: #f59e0b;\n        font-size: 15px;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n    }\n\n    .item-tempo {\n        font-weight: 600;\n        color: #6b7280;\n        font-size: 12px;\n    }\n\n    .cronometro-live {\n        font-weight: 700;\n        color: #f59e0b;\n        font-size: 14px;\n        font-family: 'Courier New', monospace;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        justify-content: center;\n        animation: glow-orange 2s infinite;\n    }\n\n    @keyframes glow-orange {\n        0%, 100% {\n            text-shadow: 0 0 5px rgba(245, 158, 11, 0.3);\n        }\n        50% {\n            text-shadow: 0 0 10px rgba(245, 158, 11, 0.6);\n        }\n    }\n\n    .horario-previsto {\n        font-weight: 700;\n        color: #3b82f6;\n        font-size: 14px;\n        font-family: 'Courier New', monospace;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        justify-content: center;\n    }\n\n    .horario-previsto.atrasado {\n        color: #ef4444;\n        animation: pulse-red 2s infinite;\n    }\n\n    @keyframes pulse-red {\n        0%, 100% {\n            opacity: 1;\n        }\n        50% {\n            opacity: 0.7;\n        }\n    }\n\n    .item-status {\n        display: inline-block;\n        padding: 8px 16px;\n        background: #d1fae5;\n        color: #065f46;\n        border-radius: 20px;\n        font-weight: 700;\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        justify-content: center;\n    }\n\n    .badge-performance {\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n        padding: 6px 12px;\n        border-radius: 16px;\n        font-weight: 700;\n        font-size: 11px;\n        text-transform: uppercase;\n        letter-spacing: 0.3px;\n        white-space: nowrap;\n    }\n\n    .badge-performance.ok {\n        background: #d1fae5;\n        color: #065f46;\n        border: 2px solid #10b981;\n    }\n\n    .badge-performance.atencao {\n        background: #fef3c7;\n        color: #92400e;\n        border: 2px solid #f59e0b;\n    }\n\n    .badge-performance.atrasado {\n        background: #fee2e2;\n        color: #991b1b;\n        border: 2px solid #ef4444;\n        animation: pulse-danger 2s infinite;\n    }\n\n    .badge-performance.sem-dados {\n        background: #f3f4f6;\n        color: #6b7280;\n        border: 2px solid #d1d5db;\n    }\n\n    @keyframes pulse-danger {\n        0%, 100% { \n            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);\n        }\n        50% { \n            box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);\n        }\n    }\n\n    /* ========== EMPTY STATE ========== */\n    .empty-state {\n        text-align: center;\n        padding: 80px 20px;\n        color: #9ca3af;\n    }\n\n    .empty-icon {\n        font-size: 80px;\n        margin-bottom: 20px;\n    }\n\n    .empty-title {\n        font-size: 24px;\n        font-weight: 700;\n        color: #6b7280;\n        margin-bottom: 8px;\n    }\n\n    .empty-text {\n        font-size: 14px;\n        color: #9ca3af;\n    }\n\n    /* ========== LOADING ========== */\n    .loading-state {\n        text-align: center;\n        padding: 60px 20px;\n    }\n\n    .loading-spinner {\n        width: 50px;\n        height: 50px;\n        border: 5px solid #e5e7eb;\n        border-top-color: #10b981;\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n        margin: 0 auto 20px;\n    }\n\n    @keyframes spin {\n        to { transform: rotate(360deg); }\n    }\n\n    /* ========== RESPONSIVE ========== */\n    @media (max-width: 1600px) {\n        .lista-header, .lista-item {\n            grid-template-columns: 40px 100px 150px 110px 65px 100px 100px 85px 85px 120px 1fr;\n            font-size: 10px;\n            gap: 6px;\n        }\n    }\n\n    @media (max-width: 768px) {\n        .retorno-title {\n            font-size: 24px;\n        }\n\n        .live-badge {\n            top: 10px;\n            right: 10px;\n            font-size: 10px;\n            padding: 6px 10px;\n        }\n\n        .filtro-section {\n            flex-direction: column;\n            align-items: stretch;\n        }\n\n        .filtro-select {\n            min-width: 100%;\n        }\n\n        .resumo-grid {\n            grid-template-columns: 1fr 1fr;\n        }\n\n        .lista-header, .lista-item {\n            grid-template-columns: 1fr;\n            gap: 8px;\n        }\n\n        .lista-header {\n            display: none;\n        }\n\n        .lista-item {\n            padding: 16px;\n        }\n\n        .lista-item > div {\n            display: flex;\n            justify-content: space-between;\n            padding: 8px 0;\n            border-bottom: 1px solid #f3f4f6;\n        }\n\n        .lista-item > div:last-child {\n            border-bottom: none;\n        }\n\n        .cronometro-live {\n            justify-content: flex-start;\n        }\n    }\n</style>\n\n<div class=\"retorno-container\">\n    <!-- HEADER -->\n    <div class=\"retorno-header\">\n        <div class=\"live-badge\">\n            <div class=\"live-dot\"></div>\n            <div>\n                <div style=\"font-weight: 800;\">AO VIVO</div>\n                <div id=\"ultimaAtualizacao\" style=\"font-size: 10px; opacity: 0.8; margin-top: 2px;\"></div>\n            </div>\n        </div>\n        <div class=\"retorno-title\">\n            üè† Retorno de Motoboys\n        </div>\n        <div class=\"retorno-subtitle\">\n            Acompanhamento em tempo real dos motoboys que finalizaram entregas e est√£o retornando\n        </div>\n    </div>\n\n    <!-- FILTRO -->\n    <div class=\"filtro-section\">\n        <div class=\"filtro-label\">üìç Filial:</div>\n        <select class=\"filtro-select\" id=\"filtroFilial\" onchange=\"aplicarFiltro()\">\n            <option value=\"\">Todas as Filiais</option>\n        </select>\n        <button class=\"btn-limpar\" onclick=\"limparFiltro()\">\n            üßπ Limpar Filtro\n        </button>\n    </div>\n\n    <!-- RESUMO -->\n    <div class=\"resumo-grid\">\n        <div class=\"resumo-card\">\n            <div class=\"resumo-icon\">üèçÔ∏è</div>\n            <div class=\"resumo-value\" id=\"totalRetornando\">-</div>\n            <div class=\"resumo-label\">Motoboys Retornando</div>\n        </div>\n        \n        <div class=\"resumo-card\">\n            <div class=\"resumo-icon\">‚úÖ</div>\n            <div class=\"resumo-value\" id=\"totalNoPrazo\" style=\"color: #10b981;\">-</div>\n            <div class=\"resumo-label\">No Prazo</div>\n        </div>\n\n        <div class=\"resumo-card\">\n            <div class=\"resumo-icon\">üö®</div>\n            <div class=\"resumo-value\" id=\"totalAtrasados\" style=\"color: #ef4444;\">-</div>\n            <div class=\"resumo-label\">Atrasados</div>\n        </div>\n\n        <div class=\"resumo-card\">\n            <div class=\"resumo-icon\">‚è±Ô∏è</div>\n            <div class=\"resumo-value\" id=\"tempoMedioRetorno\">-</div>\n            <div class=\"resumo-label\">Tempo M√©dio</div>\n        </div>\n    </div>\n\n    <!-- LISTA -->\n    <div class=\"lista-section\">\n        <div class=\"lista-title\">\n            üìã Motoboys Retornando\n            <span id=\"contadorLista\" style=\"margin-left: auto; font-size: 14px; color: #10b981;\"></span>\n        </div>\n\n        <div class=\"lista-header\">\n            <div>#</div>\n            <div>Sa√≠da ID</div>\n            <div>Motoboy</div>\n            <div>Filial</div>\n            <div>Entregas</div>\n            <div>√öltima Entrega</div>\n            <div>Deve Chegar</div>\n            <div>Tempo Real</div>\n            <div>Prev. Google</div>\n            <div>Performance</div>\n            <div>Status</div>\n        </div>\n\n        <div class=\"lista-body\" id=\"listaBody\">\n            <!-- Loading inicial -->\n            <div class=\"loading-state\">\n                <div class=\"loading-spinner\"></div>\n                <div style=\"color: #6b7280; font-weight: 600;\">Carregando dados...</div>\n            </div>\n        </div>\n    </div>\n</div>\n\n<script>\n    // ========================================\n    // DADOS GLOBAIS\n    // ========================================\n    let todosOsDados = [];\n    let dadosFiltrados = [];\n    let dadosGoogle = [];\n\n    // ========================================\n    // PROCESSAR DADOS\n    // ========================================\n    function processarRetornos() {\n        console.log('üè† Processando retornos de motoboys...');\n\n        const pedidos = window.pedidosRetorno || [];\n        \n        if (pedidos.length === 0) {\n            console.log('‚ö†Ô∏è Nenhum dado dispon√≠vel');\n            mostrarEstadoVazio();\n            return;\n        }\n\n        console.log('üìä Total de pedidos recebidos:', pedidos.length);\n\n        // ========================================\n        // AGRUPAR POR SAIDAID (1 linha = 1 sa√≠da)\n        // ========================================\n        const groupedBySaida = {};\n        \n        pedidos.forEach(pedido => {\n            const saidaId = pedido.SAIDAID;\n            \n            if (!saidaId) return; // Ignorar se n√£o tiver SAIDAID\n            \n            if (!groupedBySaida[saidaId]) {\n                groupedBySaida[saidaId] = {\n                    SAIDAID: saidaId,\n                    MOTOBOY: pedido.MOTOBOY,\n                    COD_MOTOBOY: pedido.COD_MOTOBOY,\n                    CIDADEFILIAL: pedido.CIDADEFILIAL,\n                    entregas: [],\n                    ultimaEntrega: null,\n                    ultimaEntregaData: null,\n                    totalEntregas: 0,\n                    temFimRota: false\n                };\n            }\n            \n            groupedBySaida[saidaId].entregas.push(pedido);\n            groupedBySaida[saidaId].totalEntregas++;\n            \n            // Verificar se j√° tem FIM_ROTA (se tiver, N√ÉO est√° retornando)\n            if (pedido.FIM_ROTA && pedido.FIM_ROTA !== 'null' && pedido.FIM_ROTA !== null) {\n                groupedBySaida[saidaId].temFimRota = true;\n            }\n            \n            // Encontrar √öLTIMA ENTREGA da sa√≠da (maior ENTREGA_CLIENTE)\n            const dataEntrega = pedido.ENTREGA_CLIENTE ? new Date(pedido.ENTREGA_CLIENTE) : null;\n            if (dataEntrega && !isNaN(dataEntrega)) {\n                if (!groupedBySaida[saidaId].ultimaEntregaData || dataEntrega > groupedBySaida[saidaId].ultimaEntregaData) {\n                    groupedBySaida[saidaId].ultimaEntregaData = dataEntrega;\n                    groupedBySaida[saidaId].ultimaEntrega = pedido.ENTREGA_CLIENTE;\n                }\n            }\n        });\n\n        // ========================================\n        // BUSCAR TEMPO DE RETORNO DO GOOGLE MAPS\n        // ========================================\n        Object.values(groupedBySaida).forEach(saida => {\n            // Buscar dados do Google para qualquer pedido desta sa√≠da\n            const pedidoDaSaida = saida.entregas[0]; // Pegar qualquer pedido da sa√≠da\n            \n            if (pedidoDaSaida) {\n                const googleInfo = dadosGoogle.find(g => \n                    g.PEDIDO == pedidoDaSaida.PEDIDO || \n                    g.SAIDAID == saida.SAIDAID\n                );\n                \n                if (googleInfo && googleInfo.RETORNO) {\n                    // Extrair minutos do formato \"11.2km - 17 mins\"\n                    const retornoStr = (googleInfo.RETORNO || \"\").toString();\n                    const match = retornoStr.match(/(\\d+)\\s*min/i);\n                    \n                    if (match) {\n                        const minutosGoogle = parseInt(match[1]);\n                        saida.tempoPrevistoRetorno = minutosGoogle;\n                    }\n                }\n            }\n        });\n\n        // ========================================\n        // FILTRAR: Apenas sa√≠das RETORNANDO\n        // Crit√©rio: \n        // 1. Tem √∫ltima entrega\n        // 2. N√ÉO tem FIM_ROTA (ainda n√£o retornou)\n        // 3. TODOS os pedidos j√° foram entregues (100% de entregas conclu√≠das)\n        // ========================================\n        todosOsDados = Object.values(groupedBySaida)\n            .filter(item => {\n                // Deve ter √∫ltima entrega\n                if (!item.ultimaEntrega) return false;\n                \n                // Deve ter motoboy\n                if (!item.MOTOBOY) return false;\n                \n                // N√ÉO deve ter FIM_ROTA (se j√° tem, j√° retornou)\n                if (item.temFimRota) return false;\n                \n                // ========================================\n                // NOVO FILTRO: Verificar se TODOS os pedidos foram entregues\n                // ========================================\n                const totalPedidos = item.entregas.length;\n                const pedidosEntregues = item.entregas.filter(pedido => {\n                    return pedido.ENTREGA_CLIENTE && \n                           pedido.ENTREGA_CLIENTE !== 'null' && \n                           pedido.ENTREGA_CLIENTE !== null;\n                }).length;\n                \n                // S√≥ mostrar se 100% dos pedidos foram entregues\n                if (pedidosEntregues < totalPedidos) {\n                    return false;\n                }\n                \n                return true;\n            })\n            .sort((a, b) => new Date(b.ultimaEntrega) - new Date(a.ultimaEntrega));\n\n        console.log('‚úÖ Total de SA√çDAS agrupadas:', Object.keys(groupedBySaida).length);\n        console.log('‚úÖ Sa√≠das RETORNANDO (100% entregas + sem FIM_ROTA):', todosOsDados.length);\n        \n        // Log de debug das primeiras 3 sa√≠das\n        if (todosOsDados.length > 0) {\n            console.log('üìã Primeiras 3 sa√≠das retornando (100% entregues):');\n            todosOsDados.slice(0, 3).forEach((saida, idx) => {\n                const pedidosEntregues = saida.entregas.filter(p => p.ENTREGA_CLIENTE && p.ENTREGA_CLIENTE !== 'null' && p.ENTREGA_CLIENTE !== null).length;\n                console.log(`   ${idx + 1}. SAIDA ${saida.SAIDAID} - ${saida.MOTOBOY} - ${pedidosEntregues}/${saida.totalEntregas} entregues - √öltima: ${saida.ultimaEntrega}`);\n            });\n        }\n        \n        // Debug: mostrar sa√≠das que foram filtradas (n√£o est√£o 100% entregues)\n        const saidasFiltradas = Object.values(groupedBySaida).filter(item => {\n            if (!item.ultimaEntrega || !item.MOTOBOY || item.temFimRota) return false;\n            const totalPedidos = item.entregas.length;\n            const pedidosEntregues = item.entregas.filter(p => p.ENTREGA_CLIENTE && p.ENTREGA_CLIENTE !== 'null' && p.ENTREGA_CLIENTE !== null).length;\n            return pedidosEntregues < totalPedidos;\n        });\n        \n        if (saidasFiltradas.length > 0) {\n            console.log('‚ö†Ô∏è Sa√≠das FILTRADAS (ainda t√™m pedidos para entregar):', saidasFiltradas.length);\n            saidasFiltradas.slice(0, 3).forEach((saida, idx) => {\n                const pedidosEntregues = saida.entregas.filter(p => p.ENTREGA_CLIENTE && p.ENTREGA_CLIENTE !== 'null' && p.ENTREGA_CLIENTE !== null).length;\n                console.log(`   ${idx + 1}. SAIDA ${saida.SAIDAID} - ${saida.MOTOBOY} - ${pedidosEntregues}/${saida.totalEntregas} entregues (FALTAM ${saida.totalEntregas - pedidosEntregues})`);\n            });\n        }\n        \n        // Popular filtro de filiais\n        popularFiltroFiliais();\n        \n        // Aplicar filtro inicial (todos)\n        aplicarFiltro();\n        \n        // Iniciar auto-atualiza√ß√£o dos cron√¥metros\n        iniciarAtualizacaoAutomatica();\n    }\n\n    // ========================================\n    // POPULAR FILTRO DE FILIAIS\n    // ========================================\n    function popularFiltroFiliais() {\n        const filiais = [...new Set(todosOsDados.map(item => item.CIDADEFILIAL).filter(f => f))].sort();\n        \n        const select = document.getElementById('filtroFilial');\n        select.innerHTML = '<option value=\"\">Todas as Filiais</option>';\n        \n        filiais.forEach(filial => {\n            select.innerHTML += `<option value=\"${filial}\">${filial}</option>`;\n        });\n        \n        console.log('üìç Filiais dispon√≠veis:', filiais.length);\n    }\n\n    // ========================================\n    // APLICAR FILTRO\n    // ========================================\n    function aplicarFiltro() {\n        const filialSelecionada = document.getElementById('filtroFilial').value;\n        \n        if (filialSelecionada === '') {\n            dadosFiltrados = todosOsDados;\n        } else {\n            dadosFiltrados = todosOsDados.filter(item => item.CIDADEFILIAL === filialSelecionada);\n        }\n        \n        console.log(`üîç Filtro aplicado: ${filialSelecionada || 'TODAS'} - ${dadosFiltrados.length} motoboys`);\n        \n        renderizarLista();\n        atualizarResumo();\n    }\n\n    // ========================================\n    // LIMPAR FILTRO\n    // ========================================\n    function limparFiltro() {\n        document.getElementById('filtroFilial').value = '';\n        aplicarFiltro();\n    }\n\n    // ========================================\n    // RENDERIZAR LISTA\n    // ========================================\n    function renderizarLista() {\n        const container = document.getElementById('listaBody');\n        const contador = document.getElementById('contadorLista');\n        \n        contador.textContent = `${dadosFiltrados.length} ${dadosFiltrados.length === 1 ? 'motoboy' : 'motoboys'}`;\n        \n        if (dadosFiltrados.length === 0) {\n            container.innerHTML = `\n                <div class=\"empty-state\">\n                    <div class=\"empty-icon\">üèçÔ∏è</div>\n                    <div class=\"empty-title\">Nenhum motoboy retornando</div>\n                    <div class=\"empty-text\">N√£o h√° motoboys retornando para a filial selecionada</div>\n                </div>\n            `;\n            return;\n        }\n        \n        container.innerHTML = dadosFiltrados.map((item, index) => {\n            const ultimaEntrega = new Date(item.ultimaEntrega);\n            const horaFormatada = ultimaEntrega.toLocaleTimeString('pt-BR', {\n                hour: '2-digit',\n                minute: '2-digit'\n            });\n            \n            // ========================================\n            // CALCULAR TEMPO REAL DE RETORNO (em minutos)\n            // ========================================\n            const agora = new Date();\n            const tempoRealMinutos = Math.floor((agora - ultimaEntrega) / 60000);\n            \n            let tempoRealTexto = '';\n            if (tempoRealMinutos < 60) {\n                tempoRealTexto = `${tempoRealMinutos} min`;\n            } else {\n                const horas = Math.floor(tempoRealMinutos / 60);\n                const mins = tempoRealMinutos % 60;\n                tempoRealTexto = `${horas}h ${mins}m`;\n            }\n            \n            // ========================================\n            // TEMPO PREVISTO GOOGLE MAPS\n            // ========================================\n            const tempoPrevisto = item.tempoPrevistoRetorno || null;\n            let tempoPrevistoTexto = tempoPrevisto ? `${tempoPrevisto} min` : 'N/A';\n            \n            // ========================================\n            // CALCULAR HOR√ÅRIO PREVISTO DE CHEGADA\n            // √öltima Entrega + Tempo de Retorno Google\n            // ========================================\n            let horarioPrevistoChegada = 'N/A';\n            let horarioPrevistoClass = 'horario-previsto';\n            \n            if (tempoPrevisto && tempoPrevisto > 0) {\n                const dataUltimaEntrega = new Date(ultimaEntrega);\n                const dataPrevisaoChegada = new Date(dataUltimaEntrega.getTime() + (tempoPrevisto * 60000));\n                \n                horarioPrevistoChegada = dataPrevisaoChegada.toLocaleTimeString('pt-BR', {\n                    hour: '2-digit',\n                    minute: '2-digit'\n                });\n                \n                // Se j√° passou do hor√°rio previsto, marcar como atrasado\n                if (agora > dataPrevisaoChegada) {\n                    horarioPrevistoClass = 'horario-previsto atrasado';\n                }\n            }\n            \n            // ========================================\n            // CALCULAR PERFORMANCE (Atrasado ou OK?)\n            // ========================================\n            let badgePerformance = '';\n            let badgeClass = 'sem-dados';\n            let badgeIcon = '‚ùì';\n            let badgeTexto = 'Sem Dados';\n            \n            if (tempoPrevisto && tempoPrevisto > 0) {\n                // Toler√¢ncia de +1 minuto\n                const tempoPrevComTolerancia = tempoPrevisto + 1;\n                const percentual = (tempoRealMinutos / tempoPrevComTolerancia) * 100;\n                \n                if (percentual <= 100) {\n                    // Dentro do prazo\n                    badgeClass = 'ok';\n                    badgeIcon = '‚úÖ';\n                    badgeTexto = `OK ${percentual.toFixed(0)}%`;\n                } else if (percentual <= 120) {\n                    // Leve atraso (at√© 20%)\n                    badgeClass = 'atencao';\n                    badgeIcon = '‚ö†Ô∏è';\n                    badgeTexto = `${percentual.toFixed(0)}%`;\n                } else {\n                    // Atrasado (mais de 20%)\n                    badgeClass = 'atrasado';\n                    badgeIcon = 'üö®';\n                    badgeTexto = `${percentual.toFixed(0)}%`;\n                }\n            }\n            \n            badgePerformance = `<span class=\"badge-performance ${badgeClass}\">${badgeIcon} ${badgeTexto}</span>`;\n            \n            return `\n                <div class=\"lista-item\" data-ultima-entrega=\"${item.ultimaEntrega}\" data-tempo-previsto=\"${tempoPrevisto || 0}\">\n                    <div class=\"item-numero\">${index + 1}</div>\n                    <div style=\"font-weight: 700; color: #3b82f6; font-family: 'Courier New', monospace; font-size: 11px;\">${item.SAIDAID}</div>\n                    <div class=\"item-motoboy\">${item.MOTOBOY || 'Nome n√£o dispon√≠vel'}</div>\n                    <div>\n                        <span class=\"item-filial\">${item.CIDADEFILIAL || 'N/A'}</span>\n                    </div>\n                    <div style=\"text-align: center; font-weight: 700; color: #10b981;\">${item.totalEntregas}</div>\n                    <div class=\"item-hora\">\n                        üïí ${horaFormatada}\n                    </div>\n                    <div class=\"${horarioPrevistoClass}\" data-tipo=\"horario-previsto\">\n                        üèÅ ${horarioPrevistoChegada}\n                    </div>\n                    <div class=\"cronometro-live\" data-tipo=\"tempo-real\">\n                        ‚è±Ô∏è ${tempoRealTexto}\n                    </div>\n                    <div style=\"font-weight: 600; color: #6b7280; text-align: center;\">${tempoPrevistoTexto}</div>\n                    <div style=\"text-align: center;\" data-tipo=\"performance\">\n                        ${badgePerformance}\n                    </div>\n                    <div>\n                        <span class=\"item-status\">\n                            üè† RETORNANDO\n                        </span>\n                    </div>\n                </div>\n            `;\n        }).join('');\n    }\n\n    // ========================================\n    // ATUALIZAR RESUMO\n    // ========================================\n    function atualizarResumo() {\n        // Total retornando\n        document.getElementById('totalRetornando').textContent = dadosFiltrados.length;\n        \n        // Calcular performance\n        const agora = new Date();\n        let noPrazo = 0;\n        let atrasados = 0;\n        \n        dadosFiltrados.forEach(item => {\n            if (item.tempoPrevistoRetorno && item.tempoPrevistoRetorno > 0) {\n                const tempoRealMinutos = Math.floor((agora - new Date(item.ultimaEntrega)) / 60000);\n                const tempoPrevComTolerancia = item.tempoPrevistoRetorno + 1;\n                const percentual = (tempoRealMinutos / tempoPrevComTolerancia) * 100;\n                \n                if (percentual > 120) {\n                    atrasados++;\n                } else {\n                    noPrazo++;\n                }\n            }\n        });\n        \n        document.getElementById('totalNoPrazo').textContent = noPrazo;\n        document.getElementById('totalAtrasados').textContent = atrasados;\n        \n        // Tempo m√©dio de retorno\n        if (dadosFiltrados.length > 0) {\n            const tempos = dadosFiltrados.map(item => {\n                const ultima = new Date(item.ultimaEntrega);\n                return Math.floor((agora - ultima) / 60000); // minutos\n            });\n            \n            const tempoMedio = Math.floor(tempos.reduce((a, b) => a + b, 0) / tempos.length);\n            document.getElementById('tempoMedioRetorno').textContent = `${tempoMedio}min`;\n        } else {\n            document.getElementById('tempoMedioRetorno').textContent = '-';\n        }\n    }\n\n    // ========================================\n    // MOSTRAR ESTADO VAZIO\n    // ========================================\n    function mostrarEstadoVazio() {\n        const container = document.getElementById('listaBody');\n        container.innerHTML = `\n            <div class=\"empty-state\">\n                <div class=\"empty-icon\">üèçÔ∏è</div>\n                <div class=\"empty-title\">Aguardando dados</div>\n                <div class=\"empty-text\">Conecte este template a uma query no Appsmith</div>\n            </div>\n        `;\n        \n        document.getElementById('totalRetornando').textContent = '0';\n        document.getElementById('totalNoPrazo').textContent = '0';\n        document.getElementById('totalAtrasados').textContent = '0';\n        document.getElementById('tempoMedioRetorno').textContent = '-';\n        document.getElementById('contadorLista').textContent = '0 motoboys';\n    }\n\n    // ========================================\n    // AUTO-ATUALIZAR CRON√îMETROS EM TEMPO REAL\n    // ========================================\n    function atualizarCronometros() {\n        const agora = new Date();\n        \n        // Atualizar cada linha da lista\n        document.querySelectorAll('.lista-item').forEach(linha => {\n            const ultimaEntregaStr = linha.getAttribute('data-ultima-entrega');\n            const tempoPrevisto = parseInt(linha.getAttribute('data-tempo-previsto')) || 0;\n            \n            if (!ultimaEntregaStr) return;\n            \n            const ultimaEntrega = new Date(ultimaEntregaStr);\n            const tempoRealMinutos = Math.floor((agora - ultimaEntrega) / 60000);\n            \n            // ========================================\n            // ATUALIZAR CRON√îMETRO DE TEMPO REAL\n            // ========================================\n            const cronometroElement = linha.querySelector('[data-tipo=\"tempo-real\"]');\n            if (cronometroElement) {\n                let tempoRealTexto = '';\n                if (tempoRealMinutos < 60) {\n                    tempoRealTexto = `${tempoRealMinutos} min`;\n                } else {\n                    const horas = Math.floor(tempoRealMinutos / 60);\n                    const mins = tempoRealMinutos % 60;\n                    tempoRealTexto = `${horas}h ${mins}m`;\n                }\n                cronometroElement.innerHTML = `‚è±Ô∏è ${tempoRealTexto}`;\n            }\n            \n            // ========================================\n            // ATUALIZAR HOR√ÅRIO PREVISTO DE CHEGADA\n            // ========================================\n            if (tempoPrevisto > 0) {\n                const horarioPrevistoElement = linha.querySelector('[data-tipo=\"horario-previsto\"]');\n                if (horarioPrevistoElement) {\n                    const dataUltimaEntrega = new Date(ultimaEntrega);\n                    const dataPrevisaoChegada = new Date(dataUltimaEntrega.getTime() + (tempoPrevisto * 60000));\n                    \n                    const horarioFormatado = dataPrevisaoChegada.toLocaleTimeString('pt-BR', {\n                        hour: '2-digit',\n                        minute: '2-digit'\n                    });\n                    \n                    // Se j√° passou do hor√°rio previsto, marcar como atrasado\n                    if (agora > dataPrevisaoChegada) {\n                        horarioPrevistoElement.className = 'horario-previsto atrasado';\n                    } else {\n                        horarioPrevistoElement.className = 'horario-previsto';\n                    }\n                    \n                    horarioPrevistoElement.innerHTML = `üèÅ ${horarioFormatado}`;\n                }\n            }\n            \n            // ========================================\n            // ATUALIZAR BADGE DE PERFORMANCE\n            // ========================================\n            if (tempoPrevisto > 0) {\n                const performanceElement = linha.querySelector('[data-tipo=\"performance\"]');\n                if (performanceElement) {\n                    const tempoPrevComTolerancia = tempoPrevisto + 1;\n                    const percentual = (tempoRealMinutos / tempoPrevComTolerancia) * 100;\n                    \n                    let badgeClass = 'sem-dados';\n                    let badgeIcon = '‚ùì';\n                    let badgeTexto = 'Sem Dados';\n                    \n                    if (percentual <= 100) {\n                        badgeClass = 'ok';\n                        badgeIcon = '‚úÖ';\n                        badgeTexto = `OK ${percentual.toFixed(0)}%`;\n                    } else if (percentual <= 120) {\n                        badgeClass = 'atencao';\n                        badgeIcon = '‚ö†Ô∏è';\n                        badgeTexto = `${percentual.toFixed(0)}%`;\n                    } else {\n                        badgeClass = 'atrasado';\n                        badgeIcon = 'üö®';\n                        badgeTexto = `${percentual.toFixed(0)}%`;\n                    }\n                    \n                    performanceElement.innerHTML = `<span class=\"badge-performance ${badgeClass}\">${badgeIcon} ${badgeTexto}</span>`;\n                }\n            }\n        });\n        \n        // Atualizar resumo tamb√©m\n        if (dadosFiltrados.length > 0) {\n            atualizarResumo();\n        }\n        \n        // Atualizar indicador de √∫ltima atualiza√ß√£o\n        const horaAtual = new Date().toLocaleTimeString('pt-BR', {\n            hour: '2-digit',\n            minute: '2-digit',\n            second: '2-digit'\n        });\n        const indicador = document.getElementById('ultimaAtualizacao');\n        if (indicador) {\n            indicador.textContent = `Atualizado √†s ${horaAtual}`;\n        }\n        \n        console.log('‚è±Ô∏è Cron√¥metros atualizados:', horaAtual);\n    }\n\n    // ========================================\n    // INICIAR AUTO-ATUALIZA√á√ÉO\n    // ========================================\n    let intervaloAtualizacao = null;\n    \n    function iniciarAtualizacaoAutomatica() {\n        // Limpar intervalo anterior se existir\n        if (intervaloAtualizacao) {\n            clearInterval(intervaloAtualizacao);\n        }\n        \n        // Atualizar imediatamente pela primeira vez\n        const horaInicial = new Date().toLocaleTimeString('pt-BR', {\n            hour: '2-digit',\n            minute: '2-digit',\n            second: '2-digit'\n        });\n        const indicador = document.getElementById('ultimaAtualizacao');\n        if (indicador) {\n            indicador.textContent = `Atualizado √†s ${horaInicial}`;\n        }\n        \n        // Atualizar a cada 10 segundos\n        intervaloAtualizacao = setInterval(atualizarCronometros, 10000);\n        console.log('‚úÖ Auto-atualiza√ß√£o iniciada (a cada 10 segundos)');\n        console.log('‚è±Ô∏è Primeira atualiza√ß√£o:', horaInicial);\n    }\n\n    // ========================================\n    // INICIALIZAR\n    // ========================================\n    setTimeout(() => {\n        console.log('üöÄ Inicializando template Retorno Motoboy...');\n        processarRetornos();\n    }, 500);\n</script>\n\n<!-- ========================================\n     INJE√á√ÉO DE DADOS DO APPSMITH\n     ======================================== -->\n<script>\n{{\n    (() => {\n        // ========================================\n        // L√ìGICA DE FILTRO:\n        // ========================================\n        // O JavaScript vai agrupar por SAIDAID e filtrar:\n        // 1. Agrupa todos os pedidos da mesma SAIDAID\n        // 2. Encontra a √öLTIMA entrega de cada sa√≠da\n        // 3. Verifica se TODOS os pedidos foram entregues (100%)\n        // 4. Filtra apenas sa√≠das onde FIM_ROTA est√° vazio/null\n        // 5. Busca tempo de retorno no Google Maps\n        // \n        // Resultado: 1 linha = 1 sa√≠da retornando (ap√≥s √∫ltima entrega) + performance\n        // \n        // IMPORTANTE: S√≥ mostra motoboys que J√Å FINALIZARAM todas as entregas\n        // e est√£o retornando para a filial\n        // ========================================\n        \n        const pedidos = pedidos_e_saidas_do_dia?.data || [];\n        const calculoGoogle = calculo_do_google?.data?.logistica_motoboy || [];\n        \n        console.log('üì¶ Injetando dados do Appsmith...');\n        console.log('üìä Total de registros pedidos:', pedidos.length);\n        console.log('üó∫Ô∏è Total de registros Google Maps:', calculoGoogle.length);\n        \n        return `\n            window.pedidosRetorno = ${JSON.stringify(pedidos)};\n            dadosGoogle = ${JSON.stringify(calculoGoogle)};\n            console.log('‚úÖ Dados injetados com sucesso!');\n            \n            setTimeout(() => {\n                if (typeof processarRetornos === 'function') {\n                    console.log('üè† Processando retornos...');\n                    processarRetornos();\n                }\n            }, 100);\n        `;\n    })()\n}}\n</script>\n\n<!-- ========================================\n     INSTRU√á√ïES DE USO NO APPSMITH\n     ========================================\n     \n     1. Crie uma query chamada \"pedidos_e_saidas_do_dia\":\n     \n        SELECT \n            SAIDAID,\n            MOTOBOY,\n            COD_MOTOBOY,\n            CIDADEFILIAL,\n            ENTREGA_CLIENTE,\n            FIM_ROTA,\n            PEDIDO\n        FROM sua_tabela_pedidos\n        WHERE ENTREGA_CLIENTE IS NOT NULL\n          AND ENTREGA_CLIENTE >= CURRENT_DATE\n        ORDER BY ENTREGA_CLIENTE DESC\n     \n     2. Crie uma query chamada \"calculo_do_google\":\n     \n        SELECT \n            PEDIDO,\n            SAIDAID,\n            RETORNO,\n            KM,\n            TEMPO\n        FROM sua_tabela_google_maps\n        WHERE DATA >= CURRENT_DATE\n     \n        * Campo RETORNO deve estar no formato: \"11.2km - 17 mins\"\n        * O template vai extrair os minutos automaticamente\n     \n     IMPORTANTE: \n     - O template vai FILTRAR automaticamente apenas sa√≠das onde:\n       * TODOS os pedidos t√™m ENTREGA_CLIENTE preenchido (100% entregues)\n       * Tem ENTREGA_CLIENTE (√∫ltima entrega feita)\n       * N√ÉO tem FIM_ROTA (ainda n√£o retornou √† filial)\n       * Ou seja: motoboy J√Å FINALIZOU todas as entregas e est√° voltando\n     \n     - Cada linha = 1 SA√çDA (agrupado por SAIDAID)\n     - Mostra a hora da √öLTIMA entrega de cada sa√≠da\n     - Compara tempo real vs tempo previsto do Google\n     \n     BADGES DE PERFORMANCE:\n     - ‚úÖ OK (‚â§100%): Dentro do prazo (com 1min de toler√¢ncia)\n     - ‚ö†Ô∏è ATEN√á√ÉO (101-120%): Leve atraso\n     - üö® ATRASADO (>120%): Atraso significativo\n     \n     COLUNAS DA LISTA:\n     - #: Posi√ß√£o\n     - Sa√≠da ID: Identificador da sa√≠da\n     - Motoboy: Nome do motoboy\n     - Filial: Filial de origem\n     - Entregas: Quantidade de entregas na sa√≠da\n     - √öltima Entrega: Hor√°rio da √∫ltima entrega (üïí HH:MM)\n     - **Deve Chegar: Hor√°rio previsto de chegada (üèÅ HH:MM)**\n       * C√°lculo: √öltima Entrega + Tempo Retorno Google\n       * Azul: Ainda n√£o passou do hor√°rio\n       * Vermelho piscante: J√° passou do hor√°rio previsto\n     - Tempo Real: Tempo decorrido desde √∫ltima entrega (‚è±Ô∏è)\n     - Prev. Google: Tempo previsto pelo Google Maps\n     - Performance: Badge de atraso (‚úÖ/‚ö†Ô∏è/üö®)\n     - Status: Status do motoboy (üè† RETORNANDO)\n     \n     CRON√îMETROS EM TEMPO REAL:\n     - ‚è±Ô∏è Tempo Real: Atualiza automaticamente a cada 10 segundos\n     - üèÅ Deve Chegar: Atualiza cor automaticamente (azul ‚Üí vermelho)\n     - Performance: Recalcula automaticamente o percentual de atraso\n     - Badge \"AO VIVO\": Mostra a hora da √∫ltima atualiza√ß√£o\n     - Os cron√¥metros continuam contando mesmo sem reload da p√°gina\n     \n     INDICADORES VISUAIS:\n     - üî¥ Bolinha vermelha pulsante: Sistema ao vivo\n     - ‚è±Ô∏è √çcone com brilho laranja: Cron√¥metro ativo\n     - üèÅ Azul: Dentro do hor√°rio previsto\n     - üèÅ Vermelho piscante: Passou do hor√°rio previsto\n     - \"Atualizado √†s HH:MM:SS\": √öltima atualiza√ß√£o dos dados\n     \n     3. No widget HTML/Iframe do Appsmith:\n        - Cole este c√≥digo HTML completo\n        - A inje√ß√£o {{ }} vai automaticamente conectar os dados\n     \n     4. Configure auto-refresh das queries para atualiza√ß√£o em tempo real\n        (Recomendado: refresh a cada 30-60 segundos)\n     \n     ======================================== -->\n\n",
  "topRow": 0,
  "type": "IFRAME_WIDGET",
  "version": 1,
  "widgetId": "kvv6pbx1ur",
  "widgetName": "Iframe12"
}