{
  "animateLoading": true,
  "borderOpacity": 100,
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": 1,
  "bottomRow": 147,
  "boxShadow": "{{appsmith.theme.boxShadow.appBoxShadow}}",
  "dynamicBindingPathList": [
    {
      "key": "borderRadius"
    },
    {
      "key": "boxShadow"
    },
    {
      "key": "srcDoc"
    }
  ],
  "dynamicTriggerPathList": [],
  "flexVerticalAlignment": "start",
  "isLoading": false,
  "isVisible": true,
  "key": "gw9rz40e8t",
  "leftColumn": 0,
  "mobileBottomRow": 33,
  "mobileLeftColumn": 19,
  "mobileRightColumn": 43,
  "mobileTopRow": 1,
  "needsErrorInfo": false,
  "originalBottomRow": 161,
  "originalTopRow": 20,
  "parentColumnSpace": 20.25,
  "parentId": "rlhajdfgof",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "responsiveBehavior": "fill",
  "rightColumn": 64,
  "source": "https://www.example.com",
  "srcDoc": "<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>An√°lise de Retornos por Filial - BlueTech</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background: #f5f5f5;\n            padding: 20px;\n        }\n\n        .container {\n            max-width: 1800px;\n            margin: 0 auto;\n            background: white;\n            padding: 30px;\n        }\n\n        /* Cards de Resumo */\n        .summary-cards {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n\n        .summary-card {\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            border-left: 4px solid #2c5282;\n            text-align: center;\n        }\n\n        .summary-card.intercorrencia {\n            border-left-color: #f59e0b;\n        }\n\n        .summary-card h2 {\n            font-size: 3rem;\n            margin-bottom: 5px;\n            color: #333;\n            font-weight: 300;\n        }\n\n        .summary-card p {\n            font-size: 0.9rem;\n            color: #666;\n            font-weight: 500;\n        }\n\n        .table-container {\n            overflow-x: auto;\n            margin-top: 20px;\n        }\n\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            background: white;\n            font-size: 0.9rem;\n        }\n\n        thead {\n            background: #2c5282;\n            color: white;\n        }\n\n        th {\n            padding: 12px 10px;\n            text-align: center;\n            font-weight: 600;\n            font-size: 0.85rem;\n            border-right: 1px solid rgba(255,255,255,0.2);\n        }\n\n        th:first-child {\n            text-align: left;\n            padding-left: 20px;\n        }\n\n        tbody tr {\n            border-bottom: 1px solid #e0e0e0;\n            position: relative;\n        }\n\n        tbody tr:nth-child(even) {\n            background: #f9f9f9;\n        }\n\n        tbody tr:hover {\n            background: #f0f4f8;\n        }\n\n        td {\n            padding: 10px 8px;\n            text-align: center;\n            color: #555;\n            border-right: 1px solid #e8e8e8;\n            font-size: 0.9rem;\n        }\n\n        td:first-child {\n            text-align: left;\n            font-weight: 500;\n            color: #333;\n            padding-left: 20px;\n            text-transform: uppercase;\n            font-size: 0.85rem;\n        }\n\n        .progress-bar-cell {\n            padding: 8px 10px !important;\n        }\n\n        .progress-bar {\n            position: relative;\n            height: 24px;\n            background: #f0f0f0;\n            border-radius: 0;\n            overflow: visible;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .progress-fill {\n            position: absolute;\n            left: 0;\n            top: 0;\n            height: 100%;\n            background: #4A90E2;\n            transition: width 0.3s ease;\n        }\n\n        .progress-fill.intercorrencia {\n            background: #f59e0b;\n        }\n\n        .progress-text {\n            position: relative;\n            z-index: 2;\n            font-weight: 600;\n            font-size: 0.8rem;\n        }\n\n        .text-muted {\n            color: #999;\n            font-size: 0.9rem;\n        }\n\n        /* Tooltip para mostrar pedidos */\n        .tooltip-row {\n            position: relative;\n            cursor: pointer;\n            transition: background 0.2s;\n        }\n\n        .tooltip-row:hover {\n            background: #e3f2fd !important;\n        }\n\n        .tooltip-row.active {\n            background: #bbdefb !important;\n        }\n\n        .tooltip-row.active td:first-child::before {\n            content: \"üìå \";\n        }\n\n        .tooltip-content {\n            visibility: hidden;\n            position: fixed;\n            z-index: 9999;\n            background: #333;\n            color: white;\n            padding: 12px 15px;\n            border-radius: 6px;\n            font-size: 0.85rem;\n            white-space: normal;\n            opacity: 0;\n            transition: opacity 0.3s;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            max-width: 500px;\n            cursor: default;\n            pointer-events: none;\n        }\n\n        .tooltip-row.active .tooltip-content {\n            pointer-events: auto;\n        }\n\n        .tooltip-content::after {\n            content: \"\";\n            position: absolute;\n            top: 100%;\n            left: 50%;\n            margin-left: -5px;\n            border-width: 5px;\n            border-style: solid;\n            border-color: #333 transparent transparent transparent;\n        }\n\n        .tooltip-row:hover .tooltip-content {\n            visibility: visible;\n            opacity: 1;\n        }\n\n        .tooltip-row.active .tooltip-content {\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n\n        .pedido-tag {\n            display: inline-block;\n            background: #4A90E2;\n            color: white;\n            padding: 2px 6px;\n            margin: 2px;\n            border-radius: 3px;\n            font-size: 0.8rem;\n            cursor: pointer;\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n\n        .pedido-tag:hover {\n            transform: scale(1.05);\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n            filter: brightness(1.1);\n        }\n\n        .pedido-tag:active {\n            transform: scale(0.98);\n        }\n\n        .pedido-tag.dentro {\n            background: #48bb78;\n        }\n\n        .pedido-tag.fora {\n            background: #f56565;\n        }\n\n        .pedido-tag.com-intercorrencia {\n            background: #f59e0b;\n            position: relative;\n        }\n\n        .pedido-tag.com-intercorrencia::before {\n            content: \"‚ö†Ô∏è \";\n        }\n\n        .pedido-tag.nao-retornou {\n            background: #ed8936;\n        }\n\n        /* Painel de detalhes do pedido abaixo da tabela */\n        .pedido-details-panel {\n            display: none;\n            background: #f8f9fa;\n            border: 2px solid #2c5282;\n            border-radius: 8px;\n            padding: 25px;\n            margin-top: 20px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n            animation: slideDown 0.3s ease-out;\n        }\n\n        .pedido-details-panel.active {\n            display: block;\n        }\n\n        @keyframes slideDown {\n            from {\n                opacity: 0;\n                transform: translateY(-20px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        .pedido-details-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 20px;\n            padding-bottom: 15px;\n            border-bottom: 2px solid #2c5282;\n        }\n\n        .pedido-details-close {\n            font-size: 28px;\n            font-weight: bold;\n            color: #999;\n            cursor: pointer;\n            line-height: 1;\n            transition: color 0.2s;\n            padding: 5px 10px;\n        }\n\n        .pedido-details-close:hover {\n            color: #333;\n        }\n\n        .pedido-modal-title {\n            font-size: 1.5rem;\n            font-weight: 600;\n            color: #333;\n            margin-bottom: 20px;\n            padding-right: 30px;\n        }\n\n        .pedido-info-grid {\n            display: grid;\n            grid-template-columns: repeat(2, 1fr);\n            gap: 15px;\n            margin-bottom: 20px;\n        }\n\n        .pedido-info-item {\n            background: #f9f9f9;\n            padding: 12px;\n            border-radius: 4px;\n            border-left: 3px solid #4A90E2;\n        }\n\n        .pedido-info-item.intercorrencia {\n            background: #fff3cd;\n            border-left-color: #f59e0b;\n        }\n\n        .pedido-info-label {\n            font-size: 0.75rem;\n            color: #666;\n            text-transform: uppercase;\n            margin-bottom: 4px;\n            font-weight: 600;\n        }\n\n        .pedido-info-value {\n            font-size: 1rem;\n            color: #333;\n            font-weight: 500;\n        }\n\n        .pedido-status-badge {\n            display: inline-block;\n            padding: 4px 12px;\n            border-radius: 4px;\n            font-size: 0.85rem;\n            font-weight: 600;\n        }\n\n        .pedido-status-badge.dentro {\n            background: #48bb78;\n            color: white;\n        }\n\n        .pedido-status-badge.fora {\n            background: #f56565;\n            color: white;\n        }\n\n        .pedido-status-badge.com-intercorrencia {\n            background: #f59e0b;\n            color: white;\n        }\n\n        .pedido-status-badge.nao-retornou {\n            background: #ed8936;\n            color: white;\n        }\n\n        /* Bloco de c√°lculo de tempo */\n        .calculo-tempo {\n            background: #e3f2fd;\n            border: 2px solid #2c5282;\n            border-radius: 8px;\n            padding: 20px;\n            margin: 20px 0;\n        }\n\n        .calculo-tempo h3 {\n            color: #2c5282;\n            margin-bottom: 15px;\n            font-size: 1.2rem;\n        }\n\n        .calculo-linha {\n            display: grid;\n            grid-template-columns: 200px 1fr;\n            gap: 15px;\n            padding: 10px 0;\n            border-bottom: 1px solid #bfdbfe;\n        }\n\n        .calculo-linha:last-child {\n            border-bottom: none;\n            font-weight: 700;\n            font-size: 1.1rem;\n            padding-top: 15px;\n            border-top: 2px solid #2c5282;\n        }\n\n        .calculo-label {\n            font-weight: 600;\n            color: #555;\n        }\n\n        .calculo-valor {\n            color: #333;\n        }\n\n        .calculo-valor.positivo {\n            color: #48bb78;\n        }\n\n        .calculo-valor.negativo {\n            color: #f56565;\n        }\n\n        .calculo-valor.intercorrencia {\n            color: #f59e0b;\n        }\n\n        .btn-saida {\n            background: #2c5282;\n            color: white;\n            padding: 10px 20px;\n            border: none;\n            border-radius: 6px;\n            font-size: 0.95rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: background 0.2s;\n            margin: 10px 0;\n        }\n\n        .btn-saida:hover {\n            background: #1e3a5f;\n        }\n\n        .saida-details {\n            display: none;\n            margin-top: 20px;\n            padding: 20px;\n            background: white;\n            border-radius: 6px;\n            border: 2px solid #2c5282;\n        }\n\n        .saida-details.active {\n            display: block;\n        }\n\n        .saida-pedido-item {\n            padding: 15px;\n            margin: 10px 0;\n            background: #f9f9f9;\n            border-left: 4px solid #4A90E2;\n            border-radius: 4px;\n        }\n\n        .saida-pedido-item.ultimo {\n            border-left-color: #48bb78;\n        }\n\n        .saida-pedido-item.com-intercorrencia {\n            border-left-color: #f59e0b;\n        }\n\n        .saida-pedido-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 10px;\n            font-weight: 600;\n        }\n\n        .tooltip-section {\n            margin-top: 10px;\n            padding-top: 8px;\n            border-top: 1px solid rgba(255,255,255,0.2);\n        }\n\n        .tooltip-section-title {\n            font-weight: 600;\n            margin-bottom: 4px;\n            font-size: 0.85rem;\n        }\n\n        @media (max-width: 768px) {\n            .container {\n                padding: 15px;\n            }\n\n            th, td {\n                padding: 8px;\n                font-size: 0.8rem;\n            }\n            \n            .tooltip-content {\n                max-width: 300px;\n                font-size: 0.75rem;\n            }\n        }\n        \n        /* Estilos para colunas orden√°veis */\n        th.sortable {\n            cursor: pointer;\n            user-select: none;\n            transition: background 0.2s;\n            position: relative;\n        }\n        \n        th.sortable:hover {\n            background: #1e3a5f;\n        }\n        \n        th.sortable .sort-arrow {\n            font-size: 0.8rem;\n            margin-left: 5px;\n            opacity: 0.5;\n            transition: opacity 0.2s;\n        }\n        \n        th.sortable:hover .sort-arrow {\n            opacity: 1;\n        }\n        \n        th.sortable.sorted-asc .sort-arrow::before {\n            content: '‚ñ≤';\n            opacity: 1;\n        }\n        \n        th.sortable.sorted-desc .sort-arrow::before {\n            content: '‚ñº';\n            opacity: 1;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n\n        {{\n            (() => {\n                // ========================================\n                // PARSER ROBUSTO DE TEMPO DO GOOGLE (RETORNO)\n                // ========================================\n                function parseTempoGoogleRetorno(retornoStr) {\n                    if (!retornoStr) return 0;\n                    \n                    const str = retornoStr.toString().toLowerCase();\n                    let totalMinutos = 0;\n                    \n                    // Formato t√≠pico: \"11.2km - 17 mins\" ou \"17 minutos\"\n                    const horasMatch = str.match(/(\\d+)\\s*(hora|horas|h)/);\n                    if (horasMatch) {\n                        totalMinutos += parseInt(horasMatch[1]) * 60;\n                    }\n                    \n                    const minutosMatch = str.match(/(\\d+)\\s*(minuto|minutos|min|mins|m)(?!etros)/);\n                    if (minutosMatch) {\n                        totalMinutos += parseInt(minutosMatch[1]);\n                    }\n                    \n                    // Se n√£o encontrou nada, tentar pegar s√≥ o primeiro n√∫mero\n                    if (totalMinutos === 0) {\n                        const numMatch = str.match(/(\\d+)/);\n                        if (numMatch) {\n                            totalMinutos = parseInt(numMatch[1]);\n                        }\n                    }\n                    \n                    return totalMinutos;\n                }\n                \n                // ========================================\n                // PARSER DE TEMPO DE INTERCORR√äNCIA\n                // ========================================\n                function parseTempoIntercorrencia(tempoStr) {\n                    if (!tempoStr) return 0;\n                    \n                    try {\n                        // Formato: \"0 0:30:0.0\" (dias horas:minutos:segundos.ms)\n                        const regex = /(\\d+)\\s+(\\d+):(\\d+):(\\d+)\\.(\\d+)/;\n                        const match = tempoStr.match(regex);\n                        \n                        if (match) {\n                            const [, dias, horas, minutos] = match;\n                            return parseInt(dias) * 1440 + parseInt(horas) * 60 + parseInt(minutos);\n                        }\n                        \n                        return 0;\n                    } catch (error) {\n                        console.error('Erro ao parsear tempo intercorr√™ncia:', tempoStr, error);\n                        return 0;\n                    }\n                }\n                \n                // ========================================\n                // CONVERTER HH:MM:SS para MINUTOS\n                // ========================================\n                function parseTempoRetorno(tempoStr) {\n                    if (!tempoStr) return 0;\n                    \n                    const parts = tempoStr.split(':');\n                    if (parts.length === 3) {\n                        const horas = parseInt(parts[0]) || 0;\n                        const minutos = parseInt(parts[1]) || 0;\n                        const segundos = parseInt(parts[2]) || 0;\n                        \n                        // Converter para minutos\n                        const totalMinutos = (horas * 60) + minutos + (segundos / 60);\n                        \n                        // Se for negativo, considerar 0\n                        return totalMinutos < 0 ? 0 : totalMinutos;\n                    }\n                    \n                    return 0;\n                }\n                \n                // Obter dados - USANDO O NOVO DATASET\n                const ultimosPedidos = ultimo_pedido_da_saida?.data || [];\n                const calculo = calculo_do_google?.data || { logistica_motoboy: [] };\n                const pedidosCompletos = pedidos_e_saidas_do_dia?.data || [];\n                const intercorrencias = intercorrencias_bi20?.data || [];\n                \n                if (ultimosPedidos.length === 0) {\n                    return `<p class=\"text-center text-muted\">Nenhum dado dispon√≠vel</p>`;\n                }\n                \n                const calc = calculo.logistica_motoboy || [];\n                \n                console.log('üìä === TOTAL RETORNOS COM INTERCORR√äNCIAS ===');\n                console.log('üöö √öltimos pedidos (sa√≠das):', ultimosPedidos.length);\n                console.log('üó∫Ô∏è Google data:', calc.length);\n                console.log('üì¶ Pedidos completos:', pedidosCompletos.length);\n                console.log('‚ö†Ô∏è Intercorr√™ncias:', intercorrencias.length);\n                \n                // ========================================\n                // CRIAR MAPA DE INTERCORR√äNCIAS POR PEDIDO\n                // ========================================\n                const intercorrenciasPorPedido = {};\n                intercorrencias.forEach(inter => {\n                    const pedido = inter.NUMPED;\n                    if (!intercorrenciasPorPedido[pedido]) {\n                        intercorrenciasPorPedido[pedido] = [];\n                    }\n                    intercorrenciasPorPedido[pedido].push({\n                        id: inter.ID_INTERCORRENCIA,\n                        aprovada: inter.APROVACAO_INTERCORRENCIA === 'TRUE',\n                        tempo: parseTempoIntercorrencia(inter.TEMPO_INTERCORRENCIA),\n                        descricao: inter.DESCRICAO,\n                        motoboy: inter.NOME_MOTOBOY\n                    });\n                });\n                \n                console.log('üîó Intercorr√™ncias mapeadas:', Object.keys(intercorrenciasPorPedido).length, 'pedidos com intercorr√™ncia');\n                \n                // ========================================\n                // PROCESSAR RETORNOS COM INTERCORR√äNCIAS\n                // ========================================\n                const saidasComRetorno = ultimosPedidos.map(item => {\n                    // Buscar CIDADEFILIAL do pedidos_e_saidas_do_dia\n                    let pedidoCompleto = pedidosCompletos.find(p => p.PEDIDO == item.PEDIDO);\n                    \n                    if (!pedidoCompleto) {\n                        pedidoCompleto = pedidosCompletos.find(p => p.SAIDAID == item.SAIDAID);\n                    }\n                    \n                    let cidadeFilial = pedidoCompleto?.CIDADEFILIAL || null;\n                    \n                    if (!cidadeFilial && pedidoCompleto) {\n                        cidadeFilial = pedidoCompleto.FILIAL || pedidoCompleto.CIDADE || null;\n                    }\n                    \n                    if (!cidadeFilial) {\n                        console.warn('‚ö†Ô∏è Pedido sem CIDADEFILIAL:', {\n                            PEDIDO: item.PEDIDO,\n                            SAIDAID: item.SAIDAID\n                        });\n                        cidadeFilial = 'SEM FILIAL';\n                    }\n                    \n                    // Verificar se tem intercorr√™ncia no √∫ltimo pedido\n                    const intercorrenciasDoPedido = intercorrenciasPorPedido[item.PEDIDO] || [];\n                    const temIntercorrencia = intercorrenciasDoPedido.length > 0;\n                    const temIntercorrenciaAprovada = intercorrenciasDoPedido.some(i => i.aprovada);\n                    \n                    // TEMPO REAL DE RETORNO (em minutos)\n                    let tempoRealRetorno = 0;\n                    \n                    if (item[\"TEMPO_RETORNO\"] || item[\"TEMPO RETORNO\"]) {\n                        const tempoStr = item[\"TEMPO_RETORNO\"] || item[\"TEMPO RETORNO\"];\n                        tempoRealRetorno = parseTempoRetorno(tempoStr);\n                    }\n                    \n                    // TEMPO PREVISTO DE RETORNO (Google Maps)\n                    let tempoPrevRetorno = 0;\n                    let temRetornoGoogleValido = false;\n                    \n                    const log = calc.find(l => l.PEDIDO == item.PEDIDO);\n                    \n                    if (log && log.RETORNO) {\n                        tempoPrevRetorno = parseTempoGoogleRetorno(log.RETORNO);\n                        if (tempoPrevRetorno > 0) {\n                            temRetornoGoogleValido = true;\n                        }\n                    }\n                    \n                    // ABATER TEMPO DE INTERCORR√äNCIAS APROVADAS\n                    let tempoIntercorrenciaAbatido = 0;\n                    if (temIntercorrenciaAprovada) {\n                        intercorrenciasDoPedido.forEach(inter => {\n                            if (inter.aprovada) {\n                                tempoIntercorrenciaAbatido += inter.tempo;\n                            }\n                        });\n                    }\n                    \n                    // TEMPO AJUSTADO\n                    const tempoAjustado = Math.max(0, tempoRealRetorno - tempoIntercorrenciaAbatido);\n                    \n                    return {\n                        SAIDAID: item.SAIDAID,\n                        CIDADEFILIAL: cidadeFilial,\n                        PEDIDO: item.PEDIDO,\n                        CODFILIAL: item.CODFILIAL,\n                        tempoRealRetorno: tempoRealRetorno,\n                        tempoPrevRetorno: tempoPrevRetorno,\n                        temRetornoGoogleValido: temRetornoGoogleValido,\n                        temIntercorrencia: temIntercorrencia,\n                        tempoIntercorrenciaAbatido: tempoIntercorrenciaAbatido,\n                        tempoAjustado: tempoAjustado,\n                        entregaCliente: item[\"ENTREGA_CLIENTE\"] || item[\"ENTREGA CLIENTE\"],\n                        fimRota: item[\"FIM_ROTA\"] || item[\"FIM ROTA\"],\n                        tempoRetornoStr: item[\"TEMPO_RETORNO\"] || item[\"TEMPO RETORNO\"]\n                    };\n                });\n                \n                // ========================================\n                // AGRUPAR POR FILIAL E ARMAZENAR PEDIDOS\n                // ========================================\n                const groupedByFilial = {};\n                \n                saidasComRetorno.forEach(saida => {\n                    const filial = saida.CIDADEFILIAL || 'SEM FILIAL';\n                    \n                    if (!groupedByFilial[filial]) {\n                        groupedByFilial[filial] = {\n                            filial: filial,\n                            totalRetornos: 0,\n                            dentroDoPrazo: 0,\n                            foraDoPrazo: 0,\n                            naoRetornou: 0,\n                            comIntercorrencia: 0,\n                            pedidos: []\n                        };\n                    }\n                    \n                    // Sempre contar no total\n                    groupedByFilial[filial].totalRetornos += 1;\n                    \n                    // Contar intercorr√™ncias\n                    if (saida.temIntercorrencia) {\n                        groupedByFilial[filial].comIntercorrencia++;\n                    }\n                    \n                    // Determinar status e armazenar pedido\n                    let statusPedido = 'nao-retornou';\n                    \n                    // \"N√£o Retornou\" = FIM ROTA vazio/null\n                    if (!saida.fimRota || saida.fimRota === '' || saida.fimRota === 'null' || saida.fimRota === null || saida.fimRota === undefined) {\n                        groupedByFilial[filial].naoRetornou += 1;\n                        statusPedido = 'nao-retornou';\n                    }\n                    // Se n√£o tem Google Maps ou tempo real v√°lido\n                    else if (!saida.tempoPrevRetorno || saida.tempoPrevRetorno <= 0 || !saida.tempoRealRetorno || saida.tempoRealRetorno <= 0) {\n                        groupedByFilial[filial].dentroDoPrazo += 1;\n                        statusPedido = 'dentro';\n                    }\n                    // Calcular com tempo ajustado (abatendo intercorr√™ncias)\n                    else {\n                        // Adicionar 1 minuto de toler√¢ncia ao tempo previsto\n                        const tempoPrevComTolerancia = saida.tempoPrevRetorno + 1;\n                        \n                        // Usar tempo ajustado (com intercorr√™ncias abatidas)\n                        if (saida.tempoAjustado <= tempoPrevComTolerancia) {\n                            groupedByFilial[filial].dentroDoPrazo += 1;\n                            statusPedido = 'dentro';\n                        } else {\n                            groupedByFilial[filial].foraDoPrazo += 1;\n                            statusPedido = 'fora';\n                        }\n                    }\n                    \n                    // Armazenar pedido com status\n                    groupedByFilial[filial].pedidos.push({ \n                        numero: saida.PEDIDO, \n                        status: statusPedido,\n                        temIntercorrencia: saida.temIntercorrencia\n                    });\n                });\n                \n                // Converter para array, filtrar \"SEM FILIAL\" e ordenar\n                const filiais = Object.values(groupedByFilial)\n                    .filter(f => f.filial !== 'SEM FILIAL')\n                    .sort((a, b) => a.filial.localeCompare(b.filial));\n                \n                // Calcular totais\n                const totais = {\n                    totalRetornos: filiais.reduce((sum, f) => sum + f.totalRetornos, 0),\n                    dentroDoPrazo: filiais.reduce((sum, f) => sum + f.dentroDoPrazo, 0),\n                    foraDoPrazo: filiais.reduce((sum, f) => sum + f.foraDoPrazo, 0),\n                    naoRetornou: filiais.reduce((sum, f) => sum + f.naoRetornou, 0),\n                    comIntercorrencia: filiais.reduce((sum, f) => sum + f.comIntercorrencia, 0)\n                };\n                \n                // Contar total de registros da query e quantos t√™m FIM_ROTA\n                const totalRegistrosQuery = ultimosPedidos.length;\n                const totalComFimRota = ultimosPedidos.filter(item => {\n                    const fimRota = item[\"FIM_ROTA\"] || item[\"FIM ROTA\"];\n                    return fimRota && fimRota !== '' && fimRota !== 'null' && fimRota !== null && fimRota !== undefined;\n                }).length;\n                \n                // Verificar se h√° dados v√°lidos\n                const temDadosValidos = saidasComRetorno.some(s => \n                    s.tempoRealRetorno > 0 && s.tempoPrevRetorno > 0\n                );\n                \n                console.log('üìà Totais Gerais:', totais);\n                console.log('‚úÖ Dentro do Prazo:', totais.dentroDoPrazo, `(${((totais.dentroDoPrazo / totais.totalRetornos) * 100).toFixed(2)}%)`);\n                console.log('‚ùå Fora do Prazo:', totais.foraDoPrazo, `(${((totais.foraDoPrazo / totais.totalRetornos) * 100).toFixed(2)}%)`);\n                console.log('üü† N√£o Retornou:', totais.naoRetornou, `(${((totais.naoRetornou / totais.totalRetornos) * 100).toFixed(2)}%)`);\n                console.log('‚ö†Ô∏è Com Intercorr√™ncia:', totais.comIntercorrencia, `(${((totais.comIntercorrencia / totais.totalRetornos) * 100).toFixed(2)}%)`);\n                \n                // ========================================\n                // RENDERIZAR HTML\n                // ========================================\n                return `\n                    <!-- Cards de Resumo -->\n                    <div class=\"summary-cards\">\n                        <div class=\"summary-card\">\n                            <h2>${totais.totalRetornos}</h2>\n                            <p>Total retornos</p>\n                            <small style=\"color: #64748b; font-size: 0.85rem; margin-top: 8px; display: block; line-height: 1.4;\">\n                                üí° <strong>${totalComFimRota}</strong> de <strong>${totalRegistrosQuery}</strong> registros retornaram\n                            </small>\n                        </div>\n                        \n                        <div class=\"summary-card\">\n                            <h2 style=\"color: #48bb78;\">${totais.dentroDoPrazo}</h2>\n                            <p>‚úÖ Dentro do Prazo</p>\n                        </div>\n                        \n                        <div class=\"summary-card\">\n                            <h2 style=\"color: #f56565;\">${totais.foraDoPrazo}</h2>\n                            <p>‚ùå Fora do Prazo</p>\n                        </div>\n                        \n                        <div class=\"summary-card\">\n                            <h2 style=\"color: #ed8936;\">${totais.naoRetornou}</h2>\n                            <p>üü† N√£o Retornou</p>\n                        </div>\n                        \n                        <div class=\"summary-card intercorrencia\">\n                            <h2 style=\"color: #f59e0b;\">${totais.comIntercorrencia}</h2>\n                            <p>‚ö†Ô∏è Com Intercorr√™ncia</p>\n                        </div>\n                    </div>\n                    \n                    ${!temDadosValidos ? `\n                        <div style=\"background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;\">\n                            <strong>‚ö†Ô∏è Aviso:</strong> N√£o foi poss√≠vel calcular retornos. \n                            Verifique se os campos <code>ENTREGA_CLIENTE</code> e <code>FIM_ROTA</code> t√™m timestamps completos.\n                            <br><small>Abra o Console (F12) para mais detalhes.</small>\n                        </div>\n                    ` : ''}\n                    \n                    <div class=\"table-container\">\n                        <table id=\"tabelaRetornos\">\n                            <thead>\n                                <tr>\n                                    <th class=\"sortable\" data-column=\"filial\" data-type=\"text\">\n                                        FILIAL <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"total\" data-type=\"number\">\n                                        Total <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"dentro\" data-type=\"number\">\n                                        Dentro <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"dentro-perc\" data-type=\"number\">\n                                        % <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"fora\" data-type=\"number\">\n                                        Fora <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"fora-perc\" data-type=\"number\">\n                                        % <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"nao-retornou\" data-type=\"number\">\n                                        N√£o Ret. <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"nao-retornou-perc\" data-type=\"number\">\n                                        % <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"intercorrencia\" data-type=\"number\">\n                                        ‚ö†Ô∏è Interc. <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                    <th class=\"sortable\" data-column=\"intercorrencia-perc\" data-type=\"number\">\n                                        % Interc. <span class=\"sort-arrow\">‚áÖ</span>\n                                    </th>\n                                </tr>\n                            </thead>\n                            <tbody id=\"corpoTabelaRetornos\">\n                                ${filiais.map(filial => {\n                                    const percDentro = filial.totalRetornos > 0 ? \n                                        (filial.dentroDoPrazo / filial.totalRetornos) : 0;\n                                    const percFora = filial.totalRetornos > 0 ? \n                                        (filial.foraDoPrazo / filial.totalRetornos) : 0;\n                                    const percNaoRetornou = filial.totalRetornos > 0 ? \n                                        (filial.naoRetornou / filial.totalRetornos) : 0;\n                                    const percIntercorrencia = filial.totalRetornos > 0 ? \n                                        (filial.comIntercorrencia / filial.totalRetornos) : 0;\n                                    \n                                    // Separar pedidos por categoria\n                                    const pedidosDentro = filial.pedidos.filter(p => p.status === 'dentro');\n                                    const pedidosFora = filial.pedidos.filter(p => p.status === 'fora');\n                                    const pedidosNaoRetornou = filial.pedidos.filter(p => p.status === 'nao-retornou');\n                                    const pedidosComIntercorrencia = filial.pedidos.filter(p => p.temIntercorrencia);\n                                    \n                                    // Criar HTML segmentado para tooltip\n                                    let tooltipContent = `\n                                        <strong>${filial.filial}</strong><br>\n                                        <small>Total: ${filial.totalRetornos} retornos</small>\n                                        <div style=\"max-height: 300px; overflow-y: auto;\">\n                                    `;\n                                    \n                                    if (pedidosDentro.length > 0) {\n                                        tooltipContent += `\n                                            <div class=\"tooltip-section\">\n                                                <div class=\"tooltip-section-title\">‚úÖ Dentro do Prazo (${pedidosDentro.length})</div>\n                                                ${pedidosDentro.map(p => `<span class=\"pedido-tag ${p.temIntercorrencia ? 'com-intercorrencia' : 'dentro'}\" onclick=\"mostrarDetalhesRetorno('${p.numero}', '${p.status}')\">${p.numero}</span>`).join('')}\n                                            </div>\n                                        `;\n                                    }\n                                    \n                                    if (pedidosFora.length > 0) {\n                                        tooltipContent += `\n                                            <div class=\"tooltip-section\">\n                                                <div class=\"tooltip-section-title\">‚ùå Fora do Prazo (${pedidosFora.length})</div>\n                                                ${pedidosFora.map(p => `<span class=\"pedido-tag ${p.temIntercorrencia ? 'com-intercorrencia' : 'fora'}\" onclick=\"mostrarDetalhesRetorno('${p.numero}', '${p.status}')\">${p.numero}</span>`).join('')}\n                                            </div>\n                                        `;\n                                    }\n                                    \n                                    if (pedidosNaoRetornou.length > 0) {\n                                        tooltipContent += `\n                                            <div class=\"tooltip-section\">\n                                                <div class=\"tooltip-section-title\">üü† N√£o Retornou (${pedidosNaoRetornou.length})</div>\n                                                ${pedidosNaoRetornou.map(p => `<span class=\"pedido-tag ${p.temIntercorrencia ? 'com-intercorrencia' : 'nao-retornou'}\" onclick=\"mostrarDetalhesRetorno('${p.numero}', '${p.status}')\">${p.numero}</span>`).join('')}\n                                            </div>\n                                        `;\n                                    }\n                                    \n                                    if (pedidosComIntercorrencia.length > 0) {\n                                        tooltipContent += `\n                                            <div class=\"tooltip-section\">\n                                                <div class=\"tooltip-section-title\">‚ö†Ô∏è Com Intercorr√™ncia (${pedidosComIntercorrencia.length})</div>\n                                                ${pedidosComIntercorrencia.map(p => `<span class=\"pedido-tag com-intercorrencia\" onclick=\"mostrarDetalhesRetorno('${p.numero}', '${p.status}')\">${p.numero}</span>`).join('')}\n                                            </div>\n                                        `;\n                                    }\n                                    \n                                    tooltipContent += `</div>`;\n                                    \n                                    return `\n                                        <tr class=\"tooltip-row\" \n                                            data-filial=\"${filial.filial}\"\n                                            data-total=\"${filial.totalRetornos}\"\n                                            data-dentro=\"${filial.dentroDoPrazo}\"\n                                            data-dentro-perc=\"${(percDentro * 100).toFixed(2)}\"\n                                            data-fora=\"${filial.foraDoPrazo}\"\n                                            data-fora-perc=\"${(percFora * 100).toFixed(2)}\"\n                                            data-nao-retornou=\"${filial.naoRetornou}\"\n                                            data-nao-retornou-perc=\"${(percNaoRetornou * 100).toFixed(2)}\"\n                                            data-intercorrencia=\"${filial.comIntercorrencia}\"\n                                            data-intercorrencia-perc=\"${(percIntercorrencia * 100).toFixed(2)}\">\n                                            <td>\n                                                ${filial.filial}\n                                                <div class=\"tooltip-content\">\n                                                    ${tooltipContent}\n                                                </div>\n                                            </td>\n                                            <td>${filial.totalRetornos}</td>\n                                            <td>${filial.dentroDoPrazo}</td>\n                                            <td class=\"progress-bar-cell\">\n                                                <div class=\"progress-bar\">\n                                                    <div class=\"progress-fill\" style=\"width: ${(percDentro * 100).toFixed(2)}%\"></div>\n                                                    <span class=\"progress-text\" style=\"color: #000;\">${(percDentro * 100).toFixed(2)}%</span>\n                                                </div>\n                                            </td>\n                                            <td>${filial.foraDoPrazo}</td>\n                                            <td class=\"progress-bar-cell\">\n                                                <div class=\"progress-bar\">\n                                                    <div class=\"progress-fill\" style=\"width: ${(percFora * 100).toFixed(2)}%; background: #f56565;\"></div>\n                                                    <span class=\"progress-text\" style=\"color: #000;\">${(percFora * 100).toFixed(2)}%</span>\n                                                </div>\n                                            </td>\n                                            <td>${filial.naoRetornou}</td>\n                                            <td class=\"progress-bar-cell\">\n                                                <div class=\"progress-bar\">\n                                                    <div class=\"progress-fill\" style=\"width: ${(percNaoRetornou * 100).toFixed(2)}%; background: #ed8936;\"></div>\n                                                    <span class=\"progress-text\" style=\"color: #000;\">${(percNaoRetornou * 100).toFixed(2)}%</span>\n                                                </div>\n                                            </td>\n                                            <td>${filial.comIntercorrencia}</td>\n                                            <td class=\"progress-bar-cell\">\n                                                <div class=\"progress-bar\">\n                                                    <div class=\"progress-fill intercorrencia\" style=\"width: ${(percIntercorrencia * 100).toFixed(2)}%;\"></div>\n                                                    <span class=\"progress-text\" style=\"color: #000;\">${(percIntercorrencia * 100).toFixed(2)}%</span>\n                                                </div>\n                                            </td>\n                                        </tr>\n                                    `;\n                                }).join('')}\n                            </tbody>\n                        </table>\n                    </div>\n                `;\n            })()\n        }}\n        \n        <!-- Painel de detalhes do retorno (fora do template) -->\n        <div id=\"pedidoDetailsPanel\" class=\"pedido-details-panel\">\n            <div class=\"pedido-details-header\">\n                <div class=\"pedido-modal-title\" id=\"pedidoDetailsTitle\"></div>\n                <span class=\"pedido-details-close\" onclick=\"fecharDetalhes()\">&times;</span>\n            </div>\n            <div id=\"pedidoDetailsBody\"></div>\n        </div>\n    </div>\n\n    <script>\n        // ========================================\n        // FUN√á√ïES DE PARSE (MESMO DO TEMPLATE)\n        // ========================================\n        function parseTempoGoogleRetorno(retornoStr) {\n            if (!retornoStr) return 0;\n            \n            const str = retornoStr.toString().toLowerCase();\n            let totalMinutos = 0;\n            \n            const horasMatch = str.match(/(\\d+)\\s*(hora|horas|h)/);\n            if (horasMatch) {\n                totalMinutos += parseInt(horasMatch[1]) * 60;\n            }\n            \n            const minutosMatch = str.match(/(\\d+)\\s*(minuto|minutos|min|mins|m)(?!etros)/);\n            if (minutosMatch) {\n                totalMinutos += parseInt(minutosMatch[1]);\n            }\n            \n            if (totalMinutos === 0) {\n                const numMatch = str.match(/(\\d+)/);\n                if (numMatch) {\n                    totalMinutos = parseInt(numMatch[1]);\n                }\n            }\n            \n            return totalMinutos;\n        }\n        \n        function parseTempoIntercorrencia(tempoStr) {\n            if (!tempoStr) return 0;\n            \n            try {\n                const regex = /(\\d+)\\s+(\\d+):(\\d+):(\\d+)\\.(\\d+)/;\n                const match = tempoStr.match(regex);\n                \n                if (match) {\n                    const [, dias, horas, minutos] = match;\n                    return parseInt(dias) * 1440 + parseInt(horas) * 60 + parseInt(minutos);\n                }\n                \n                return 0;\n            } catch (error) {\n                console.error('Erro ao parsear tempo intercorr√™ncia:', tempoStr, error);\n                return 0;\n            }\n        }\n        \n        function parseTempoRetorno(tempoStr) {\n            if (!tempoStr) return 0;\n            \n            const parts = tempoStr.split(':');\n            if (parts.length === 3) {\n                const horas = parseInt(parts[0]) || 0;\n                const minutos = parseInt(parts[1]) || 0;\n                const segundos = parseInt(parts[2]) || 0;\n                \n                const totalMinutos = (horas * 60) + minutos + (segundos / 60);\n                return totalMinutos < 0 ? 0 : totalMinutos;\n            }\n            \n            return 0;\n        }\n        \n        // Dados globais para o modal\n        let ultimosPedidosData = [];\n        let googleData = [];\n        let pedidosCompletosData = [];\n        let intercorrenciasData = [];\n        \n        // Armazenar dados (executar imediatamente)\n        {{\n            (() => {\n                const ultimos = ultimo_pedido_da_saida?.data || [];\n                return `ultimosPedidosData = ${JSON.stringify(ultimos)};`;\n            })()\n        }}\n        \n        {{\n            (() => {\n                const calculo = calculo_do_google?.data?.logistica_motoboy || [];\n                return `googleData = ${JSON.stringify(calculo)};`;\n            })()\n        }}\n        \n        {{\n            (() => {\n                const pedidos = pedidos_e_saidas_do_dia?.data || [];\n                return `pedidosCompletosData = ${JSON.stringify(pedidos)};`;\n            })()\n        }}\n        \n        {{\n            (() => {\n                const intercorrencias = intercorrencias_bi20?.data || [];\n                return `intercorrenciasData = ${JSON.stringify(intercorrencias)};`;\n            })()\n        }}\n        \n        // Usar setTimeout para garantir que o DOM foi renderizado\n        setTimeout(function() {\n            const rows = document.querySelectorAll('.tooltip-row');\n            \n            rows.forEach(row => {\n                row.addEventListener('click', function(e) {\n                    if (e.target.classList.contains('pedido-tag')) {\n                        return;\n                    }\n                    \n                    e.stopPropagation();\n                    \n                    rows.forEach(r => {\n                        if (r !== row) {\n                            r.classList.remove('active');\n                        }\n                    });\n                    \n                    const wasActive = row.classList.contains('active');\n                    row.classList.toggle('active');\n                    \n                    if (!wasActive) {\n                        positionTooltip(row);\n                    }\n                });\n            });\n            \n            function positionTooltip(row) {\n                const tooltip = row.querySelector('.tooltip-content');\n                const rect = row.getBoundingClientRect();\n                \n                tooltip.style.left = rect.left + (rect.width / 2) + 'px';\n                tooltip.style.top = (rect.top - 10) + 'px';\n                tooltip.style.transform = 'translate(-50%, -100%)';\n            }\n            \n            document.addEventListener('click', function(e) {\n                if (!e.target.closest('.tooltip-row') && !e.target.closest('.pedido-details-panel')) {\n                    rows.forEach(row => {\n                        row.classList.remove('active');\n                    });\n                }\n            });\n            \n            document.querySelectorAll('.tooltip-content').forEach(tooltip => {\n                tooltip.addEventListener('click', function(e) {\n                    e.stopPropagation();\n                });\n            });\n            \n            console.log('‚úÖ Event listeners configurados (Retornos)!');\n            console.log('üì¶ √öltimos pedidos carregados:', ultimosPedidosData.length);\n            console.log('üó∫Ô∏è Google data carregado:', googleData.length);\n            console.log('üöö Pedidos completos carregados:', pedidosCompletosData.length);\n            console.log('‚ö†Ô∏è Intercorr√™ncias carregadas:', intercorrenciasData.length);\n            \n            // ========================================\n            // ORDENA√á√ÉO DE COLUNAS\n            // ========================================\n            const sortableHeaders = document.querySelectorAll('th.sortable');\n            let currentSort = { column: null, direction: 'asc' };\n            \n            sortableHeaders.forEach(header => {\n                header.addEventListener('click', function() {\n                    const column = this.getAttribute('data-column');\n                    const type = this.getAttribute('data-type');\n                    \n                    if (currentSort.column === column) {\n                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';\n                    } else {\n                        currentSort.direction = 'asc';\n                    }\n                    currentSort.column = column;\n                    \n                    sortableHeaders.forEach(h => {\n                        h.classList.remove('sorted-asc', 'sorted-desc');\n                    });\n                    \n                    this.classList.add(`sorted-${currentSort.direction}`);\n                    \n                    sortTable(column, type, currentSort.direction);\n                });\n            });\n            \n            function sortTable(column, type, direction) {\n                const tbody = document.getElementById('corpoTabelaRetornos');\n                const rows = Array.from(tbody.querySelectorAll('tr'));\n                \n                rows.sort((a, b) => {\n                    let aVal = a.getAttribute(`data-${column}`);\n                    let bVal = b.getAttribute(`data-${column}`);\n                    \n                    if (type === 'number') {\n                        aVal = parseFloat(aVal) || 0;\n                        bVal = parseFloat(bVal) || 0;\n                        return direction === 'asc' ? aVal - bVal : bVal - aVal;\n                    } else {\n                        aVal = (aVal || '').toString().toLowerCase();\n                        bVal = (bVal || '').toString().toLowerCase();\n                        if (direction === 'asc') {\n                            return aVal.localeCompare(bVal);\n                        } else {\n                            return bVal.localeCompare(aVal);\n                        }\n                    }\n                });\n                \n                tbody.innerHTML = '';\n                rows.forEach(row => tbody.appendChild(row));\n                \n                console.log(`üìä Tabela ordenada por ${column} (${direction})`);\n            }\n        }, 500);\n        \n        function fecharDetalhes() {\n            const panel = document.getElementById('pedidoDetailsPanel');\n            if (panel) {\n                panel.classList.remove('active');\n            }\n        }\n        \n        function mostrarDetalhesRetorno(pedidoNum, statusPedido) {\n            console.log('üìã Mostrando detalhes do retorno:', pedidoNum, 'Status:', statusPedido);\n            \n            const pedidoUltimo = ultimosPedidosData.find(p => p.PEDIDO == pedidoNum);\n            const pedidoCompleto = pedidosCompletosData.find(p => p.PEDIDO == pedidoNum);\n            \n            if (!pedidoUltimo && !pedidoCompleto) {\n                console.error('‚ùå Pedido n√£o encontrado:', pedidoNum);\n                alert('Pedido n√£o encontrado!');\n                return;\n            }\n            \n            const pedido = pedidoCompleto || pedidoUltimo;\n            const googleInfo = googleData.find(g => g.PEDIDO == pedidoNum);\n            \n            // Buscar intercorr√™ncias do pedido\n            const intercorrenciasDoPedido = intercorrenciasData.filter(i => i.NUMPED == pedidoNum);\n            const temIntercorrencia = intercorrenciasDoPedido.length > 0;\n            \n            console.log('‚ö†Ô∏è Intercorr√™ncias:', intercorrenciasDoPedido);\n            \n            // Calcular tempos\n            const tempoRealRetorno = parseTempoRetorno(pedidoUltimo?.[\"TEMPO_RETORNO\"] || pedidoUltimo?.[\"TEMPO RETORNO\"]);\n            const tempoPrevRetorno = googleInfo ? parseTempoGoogleRetorno(googleInfo.RETORNO) : 0;\n            \n            // Calcular tempo de intercorr√™ncias aprovadas\n            let tempoIntercorrenciaAbatido = 0;\n            let intercorrenciasAprovadas = [];\n            intercorrenciasDoPedido.forEach(inter => {\n                if (inter.APROVACAO_INTERCORRENCIA === 'TRUE') {\n                    const tempo = parseTempoIntercorrencia(inter.TEMPO_INTERCORRENCIA);\n                    tempoIntercorrenciaAbatido += tempo;\n                    intercorrenciasAprovadas.push({\n                        id: inter.ID_INTERCORRENCIA,\n                        tempo: tempo,\n                        descricao: inter.DESCRICAO,\n                        quemAprovou: inter.NOME_QUEM_APROVOU,\n                        justificativa: inter.JUSTIFICATIVA_APROVACAO\n                    });\n                }\n            });\n            \n            // Tempo ajustado\n            const tempoAjustado = Math.max(0, tempoRealRetorno - tempoIntercorrenciaAbatido);\n            \n            // Determinar status\n            let status = statusPedido || 'nao-retornou';\n            let statusTexto = 'üü† N√£o Retornou';\n            \n            if (status === 'dentro') {\n                statusTexto = '‚úÖ Dentro do Prazo';\n            } else if (status === 'fora') {\n                statusTexto = '‚ùå Fora do Prazo';\n            }\n            \n            if (temIntercorrencia) {\n                statusTexto += ' ‚ö†Ô∏è';\n            }\n            \n            const formatarData = (data) => {\n                if (!data) return 'N/A';\n                const d = new Date(data);\n                return d.toLocaleString('pt-BR');\n            };\n            \n            // Atualizar painel\n            const panel = document.getElementById('pedidoDetailsPanel');\n            const title = document.getElementById('pedidoDetailsTitle');\n            const body = document.getElementById('pedidoDetailsBody');\n            \n            if (!panel || !title || !body) {\n                console.error('‚ùå Elementos do painel n√£o encontrados');\n                return;\n            }\n            \n            title.innerHTML = `Retorno - Pedido ${pedidoNum}`;\n            body.innerHTML = `\n                <div style=\"margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;\">\n                    <span class=\"pedido-status-badge ${temIntercorrencia ? 'com-intercorrencia' : status}\">${statusTexto}</span>\n                    <button class=\"btn-saida\" onclick=\"mostrarRetornosDaSaida('${pedido.SAIDAID}')\">\n                        üöö Ver Retorno Completo da Sa√≠da ${pedido.SAIDAID}\n                    </button>\n                </div>\n                \n                <!-- C√ÅLCULO DE TEMPO DETALHADO -->\n                ${googleInfo && tempoPrevRetorno > 0 ? `\n                <div class=\"calculo-tempo\">\n                    <h3>üìä C√°lculo Detalhado de Retorno</h3>\n                    \n                    <div class=\"calculo-linha\">\n                        <div class=\"calculo-label\">üïê Tempo Real de Retorno:</div>\n                        <div class=\"calculo-valor\">${tempoRealRetorno.toFixed(2)} minutos</div>\n                    </div>\n                    \n                    ${temIntercorrencia && intercorrenciasAprovadas.length > 0 ? `\n                    <div class=\"calculo-linha\">\n                        <div class=\"calculo-label\">‚ö†Ô∏è Intercorr√™ncia(s) Aprovada(s):</div>\n                        <div class=\"calculo-valor intercorrencia\">- ${tempoIntercorrenciaAbatido.toFixed(2)} minutos (ABATIDO)</div>\n                    </div>\n                    \n                    <div class=\"calculo-linha\">\n                        <div class=\"calculo-label\">‚úÖ Tempo Ajustado (Real - Interc.):</div>\n                        <div class=\"calculo-valor\">${tempoAjustado.toFixed(2)} minutos</div>\n                    </div>\n                    ` : ''}\n                    \n                    <div class=\"calculo-linha\">\n                        <div class=\"calculo-label\">üó∫Ô∏è Tempo Google Maps:</div>\n                        <div class=\"calculo-valor\">${tempoPrevRetorno} minutos (original: \"${googleInfo.RETORNO}\")</div>\n                    </div>\n                    \n                    <div class=\"calculo-linha\">\n                        <div class=\"calculo-label\">‚è±Ô∏è Com Toler√¢ncia (+1min):</div>\n                        <div class=\"calculo-valor\">${tempoPrevRetorno + 1} minutos</div>\n                    </div>\n                    \n                    <div class=\"calculo-linha\">\n                        <div class=\"calculo-label\">üìà Resultado:</div>\n                        <div class=\"calculo-valor ${tempoAjustado <= (tempoPrevRetorno + 1) ? 'positivo' : 'negativo'}\">\n                            ${tempoAjustado.toFixed(2)} ${tempoAjustado <= (tempoPrevRetorno + 1) ? '‚â§' : '>'} ${tempoPrevRetorno + 1} = \n                            ${tempoAjustado <= (tempoPrevRetorno + 1) ? '‚úÖ DENTRO DO PRAZO' : '‚ùå FORA DO PRAZO'}\n                        </div>\n                    </div>\n                </div>\n                ` : '<div style=\"background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;\"><strong>‚ö†Ô∏è Aviso:</strong> Dados do Google Maps n√£o encontrados para este retorno.</div>'}\n                \n                <!-- INTERCORR√äNCIAS -->\n                ${temIntercorrencia ? `\n                <div style=\"background: #fff3cd; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n                    <h3 style=\"color: #f59e0b; margin-bottom: 15px;\">‚ö†Ô∏è Intercorr√™ncias Registradas (${intercorrenciasDoPedido.length})</h3>\n                    ${intercorrenciasDoPedido.map(inter => {\n                        const tempo = parseTempoIntercorrencia(inter.TEMPO_INTERCORRENCIA);\n                        const aprovada = inter.APROVACAO_INTERCORRENCIA === 'TRUE';\n                        return `\n                        <div class=\"pedido-info-grid\" style=\"margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f59e0b;\">\n                            <div class=\"pedido-info-item intercorrencia\">\n                                <div class=\"pedido-info-label\">ID Intercorr√™ncia</div>\n                                <div class=\"pedido-info-value\">#${inter.ID_INTERCORRENCIA}</div>\n                            </div>\n                            \n                            <div class=\"pedido-info-item intercorrencia\">\n                                <div class=\"pedido-info-label\">Status</div>\n                                <div class=\"pedido-info-value\">${aprovada ? '‚úÖ APROVADA' : '‚è≥ Pendente'}</div>\n                            </div>\n                            \n                            <div class=\"pedido-info-item intercorrencia\">\n                                <div class=\"pedido-info-label\">Tempo Intercorr√™ncia</div>\n                                <div class=\"pedido-info-value\">${tempo.toFixed(2)} minutos ${aprovada ? '(ABATIDO)' : '(N√ÉO ABATIDO)'}</div>\n                            </div>\n                            \n                            <div class=\"pedido-info-item intercorrencia\">\n                                <div class=\"pedido-info-label\">Motoboy</div>\n                                <div class=\"pedido-info-value\">${inter.NOME_MOTOBOY || 'N/A'}</div>\n                            </div>\n                            \n                            <div class=\"pedido-info-item intercorrencia\" style=\"grid-column: 1 / -1;\">\n                                <div class=\"pedido-info-label\">Descri√ß√£o</div>\n                                <div class=\"pedido-info-value\">${inter.DESCRICAO || 'Sem descri√ß√£o'}</div>\n                            </div>\n                            \n                            ${aprovada ? `\n                            <div class=\"pedido-info-item intercorrencia\">\n                                <div class=\"pedido-info-label\">Aprovado Por</div>\n                                <div class=\"pedido-info-value\">${inter.NOME_QUEM_APROVOU || 'N/A'}</div>\n                            </div>\n                            \n                            <div class=\"pedido-info-item intercorrencia\">\n                                <div class=\"pedido-info-label\">Justificativa</div>\n                                <div class=\"pedido-info-value\">${inter.JUSTIFICATIVA_APROVACAO || 'Sem justificativa'}</div>\n                            </div>\n                            ` : ''}\n                        </div>\n                        `;\n                    }).join('')}\n                </div>\n                ` : ''}\n                \n                <div id=\"saidaDetails\" class=\"saida-details\"></div>\n                \n                <h3 style=\"font-size: 1.1rem; margin-bottom: 10px; color: #2c5282;\">üìã Informa√ß√µes da Sa√≠da</h3>\n                <div class=\"pedido-info-grid\">\n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">Sa√≠da ID</div>\n                        <div class=\"pedido-info-value\">${pedido.SAIDAID || 'N/A'}</div>\n                    </div>\n                    \n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">Filial</div>\n                        <div class=\"pedido-info-value\">${pedidoUltimo?.FILIAL || pedido.CIDADEFILIAL || 'N/A'}</div>\n                    </div>\n                    \n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">Motoboy</div>\n                        <div class=\"pedido-info-value\">${pedido.MOTOBOY || 'N/A'}</div>\n                    </div>\n                    \n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">√öltimo Pedido Entregue</div>\n                        <div class=\"pedido-info-value\">${pedidoNum}</div>\n                    </div>\n                </div>\n                \n                <h3 style=\"font-size: 1.1rem; margin: 20px 0 10px; color: #2c5282;\">‚è±Ô∏è Tempos de Retorno</h3>\n                <div class=\"pedido-info-grid\">\n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">√öltima Entrega</div>\n                        <div class=\"pedido-info-value\">${formatarData(pedidoUltimo?.[\"ENTREGA_CLIENTE\"] || pedidoUltimo?.[\"ENTREGA CLIENTE\"] || pedido.ENTREGA_CLIENTE)}</div>\n                    </div>\n                    \n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">Fim da Rota</div>\n                        <div class=\"pedido-info-value\">${formatarData(pedidoUltimo?.[\"FIM_ROTA\"] || pedidoUltimo?.[\"FIM ROTA\"] || pedido.FIM_ROTA) || '‚ö†Ô∏è N√£o retornou'}</div>\n                    </div>\n                    \n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">Tempo Real de Retorno</div>\n                        <div class=\"pedido-info-value\">${pedidoUltimo?.[\"TEMPO_RETORNO\"] || pedidoUltimo?.[\"TEMPO RETORNO\"] || 'N/A'}</div>\n                    </div>\n                    \n                    <div class=\"pedido-info-item\">\n                        <div class=\"pedido-info-label\">Tempo Previsto (Google)</div>\n                        <div class=\"pedido-info-value\">${googleInfo?.RETORNO || 'N/A'}</div>\n                    </div>\n                </div>\n            `;\n            \n            panel.classList.add('active');\n            setTimeout(() => {\n                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n            }, 100);\n        }\n        \n        function mostrarRetornosDaSaida(saidaId) {\n            console.log('üöö Mostrando retorno da SAIDA:', saidaId);\n            \n            const pedidosDaSaida = pedidosCompletosData.filter(p => p.SAIDAID == saidaId);\n            \n            if (pedidosDaSaida.length === 0) {\n                alert('Nenhum pedido encontrado para esta sa√≠da!');\n                return;\n            }\n            \n            pedidosDaSaida.sort((a, b) => new Date(a.ENTREGA_CLIENTE) - new Date(b.ENTREGA_CLIENTE));\n            \n            const ultimoPedido = pedidosDaSaida[pedidosDaSaida.length - 1];\n            const ultimoPedidoInfo = ultimosPedidosData.find(p => p.PEDIDO == ultimoPedido.PEDIDO);\n            const googleInfo = googleData.find(g => g.PEDIDO == ultimoPedido.PEDIDO);\n            \n            const formatarHora = (data) => {\n                if (!data) return 'N/A';\n                const d = new Date(data);\n                return d.toLocaleTimeString('pt-BR');\n            };\n            \n            let html = `\n                <h3 style=\"font-size: 1.2rem; margin-bottom: 15px; color: #2c5282;\">\n                    üèÅ Retorno da Sa√≠da ${saidaId}\n                </h3>\n                \n                <div class=\"saida-pedido-item ultimo\">\n                    <div class=\"saida-pedido-header\">\n                        <span style=\"font-size: 1.1rem;\">üèÅ √öltimo Pedido - ${ultimoPedido.PEDIDO}</span>\n                    </div>\n                    \n                    <div style=\"display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;\">\n                        <div>\n                            <strong>Cliente:</strong> ${ultimoPedido.RAZAO_SOCIAL || 'N/A'}\n                        </div>\n                        <div>\n                            <strong>√öltima Entrega:</strong> ${formatarHora(ultimoPedido.ENTREGA_CLIENTE)}\n                        </div>\n                        <div>\n                            <strong>Fim da Rota:</strong> ${ultimoPedidoInfo ? formatarHora(ultimoPedidoInfo[\"FIM_ROTA\"] || ultimoPedidoInfo[\"FIM ROTA\"]) : 'N/A'}\n                        </div>\n                        <div>\n                            <strong>Tempo de Retorno:</strong> ${ultimoPedidoInfo?.[\"TEMPO_RETORNO\"] || ultimoPedidoInfo?.[\"TEMPO RETORNO\"] || 'N/A'}\n                        </div>\n                        <div>\n                            <strong>Tempo Google:</strong> ${googleInfo?.RETORNO || 'N/A'}\n                        </div>\n                    </div>\n                </div>\n                \n                <div style=\"margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px;\">\n                    <strong>üìä Resumo da Rota</strong>\n                    <div style=\"margin-top: 10px;\">\n                        Total de entregas: ${pedidosDaSaida.length}<br>\n                        In√≠cio da rota: ${formatarHora(pedidosDaSaida[0].INICIO_ROTA)}<br>\n                        √öltima entrega: ${formatarHora(ultimoPedido.ENTREGA_CLIENTE)}<br>\n                        Fim da rota: ${ultimoPedidoInfo ? formatarHora(ultimoPedidoInfo[\"FIM_ROTA\"] || ultimoPedidoInfo[\"FIM ROTA\"]) : '‚ö†Ô∏è N√£o retornou'}\n                    </div>\n                </div>\n            `;\n            \n            const container = document.getElementById('saidaDetails');\n            if (container) {\n                container.innerHTML = html;\n                container.classList.add('active');\n                \n                setTimeout(() => {\n                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\n                }, 100);\n            }\n        }\n    </script>\n</body>\n</html>\n\n",
  "topRow": 72,
  "type": "IFRAME_WIDGET",
  "version": 1,
  "widgetId": "5gfhku712h",
  "widgetName": "Iframe1Copy1Copy1"
}